<!DOCTYPE html>

<html>
<head>
  <title>deploy</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>deploy</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">#!/usr/bin/env bash

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><strong><em>A shell script to deploy Git repositories.</em></strong></p>
<ul>
<li><strong>Source:</strong> <a href="https://github.com/AlphaHydrae/deploy">https://github.com/AlphaHydrae/deploy</a></li>
<li><strong>Originally by:</strong> <a href="https://github.com/visionmedia/deploy">https://github.com/visionmedia/deploy</a></li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="usage">Usage</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">usage</span></span>() {
  cat &lt;&lt;-EOF

  Usage: deploy [options] &lt;env&gt; &lt;<span class="hljs-built_in">command</span>&gt;

  Options:

    -C, --<span class="hljs-built_in">chdir</span> &lt;path&gt;    change the working directory to &lt;path&gt;
    -c, --config &lt;path&gt;   <span class="hljs-built_in">set</span> config path. defaults to ./deploy.conf
    -V, --version         output program version
    -h, --<span class="hljs-built_in">help</span>            output <span class="hljs-built_in">help</span> information

  Commands:

    &lt;env&gt; setup              run remote setup commands
    &lt;env&gt; ref [ref]          deploy a release (commit, branch or tag)
    [env] config [key]       output config file, a section, or one value
    &lt;env&gt; config-all [key]   output all values of a config key <span class="hljs-keyword">in</span> an environment
    &lt;env&gt; console [path]     open an ssh session to the host
    &lt;env&gt; <span class="hljs-built_in">exec</span> &lt;cmd&gt;         execute the given <span class="hljs-built_in">command</span> on the host
    &lt;env&gt; list               list previous deploy commits
    update                   update this script to the latest version

  Examples:

    deploy prod setup             run remote setup <span class="hljs-keyword">in</span> the prod env
    deploy dev ref master         deploy the master branch <span class="hljs-keyword">in</span> the dev env
    deploy prod <span class="hljs-built_in">exec</span> pm2 status   run <span class="hljs-string">'pm2 status'</span> <span class="hljs-keyword">in</span> the prod env
    deploy dev config user        get the value of the user key <span class="hljs-keyword">in</span> the dev env

EOF
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="sub-commands">Sub-commands</h2>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h3 id="-env-setup-"><code>&lt;env&gt; setup</code></h3>
<p>Perform first-time setup tasks before deployment.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">setup</span></span>() {
  <span class="hljs-built_in">local</span> path=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_value path)</span>"</span>
  <span class="hljs-built_in">local</span> repo=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_value repo)</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Run user-defined <code>pre-setup</code> hooks (if any).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hooks pre-setup <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Create the <code>releases</code> and <code>tmp</code> directories in the deployment directory
if they don’t already exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> running setup
  run <span class="hljs-string">"{ test -d <span class="hljs-variable">$path</span> || exit 1; } \
       &amp;&amp; mkdir -p <span class="hljs-variable">$path</span>/releases <span class="hljs-variable">$path</span>/tmp"</span> \
    || abort <span class="hljs-string">"failed to set up directories; make sure <span class="hljs-variable">$path</span> exists and is writable"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Clone the repository into <code>repo</code> in the deployment directory
if it isn’t already there.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> cloning repo
  run <span class="hljs-string">"test -d <span class="hljs-variable">$path</span>/repo \
       || { git clone --bare <span class="hljs-variable">$repo</span> <span class="hljs-variable">$path</span>/repo || exit 1; }"</span> \
    || abort <span class="hljs-string">"failed to clone repo"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Run user-defined <code>post-setup</code> hooks (if any).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hooks post-setup <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span>

  <span class="hljs-built_in">log</span> setup complete
}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3 id="-env-ref-ref-"><code>&lt;env&gt; ref [ref]</code></h3>
<p>Deploys the latest changes from the repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">deploy_ref</span></span>() {
  <span class="hljs-built_in">local</span> path=`get_last_config_value path`
  <span class="hljs-built_in">local</span> release=`date -u <span class="hljs-string">'+%Y-%m-%d-%H-%M-%S'</span>`
  <span class="hljs-built_in">local</span> current_dir=<span class="hljs-string">"<span class="hljs-variable">$path</span>/current"</span>
  <span class="hljs-built_in">local</span> release_dir=<span class="hljs-string">"<span class="hljs-variable">$path</span>/releases/<span class="hljs-variable">$release</span>"</span>
  <span class="hljs-built_in">local</span> tmp_dir=<span class="hljs-string">"<span class="hljs-variable">$path</span>/tmp"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>A Git reference to a commit, branch or tag is required,
either from the command line argument or from a <code>ref</code> key in the configuration file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> ref=<span class="hljs-variable">${1:-`get_last_config_value ref`}</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$ref</span>"</span> || abort <span class="hljs-string">"no commit, branch or tag specified"</span>

  <span class="hljs-built_in">log</span> deploying
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"    ref: <span class="hljs-variable">$ref</span>"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"    release: <span class="hljs-variable">$release</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Run user-defined pre-deploy hooks (if any).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hooks pre-deploy <span class="hljs-variable">$current_dir</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Fetch the latest changes from the repository (from the specified ref).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> fetching updates
  run <span class="hljs-string">"cd <span class="hljs-variable">$path</span>/repo \
       &amp;&amp; git fetch origin '+refs/heads/*:refs/heads/*' \
       &amp;&amp; git rev-list -n 1 <span class="hljs-variable">$ref</span>"</span> \
    || abort <span class="hljs-string">"could not fetch changes"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Extract the sources at the specified ref into the <code>releases</code> directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> <span class="hljs-string">"extracting source at <span class="hljs-variable">$ref</span>"</span>
  run <span class="hljs-string">"cd <span class="hljs-variable">$path</span>/repo \
       &amp;&amp; mkdir -p <span class="hljs-variable">$release_dir</span> \
       &amp;&amp; git archive --output <span class="hljs-variable">$tmp_dir</span>/release-<span class="hljs-variable">$release</span>.tar <span class="hljs-variable">$ref</span> \
       &amp;&amp; tar -C <span class="hljs-variable">$release_dir</span> -x --file <span class="hljs-variable">$tmp_dir</span>/release-<span class="hljs-variable">$release</span>.tar \
       &amp;&amp; rm -f <span class="hljs-variable">$tmp_dir</span>/release-*.tar"</span> \
    || abort <span class="hljs-string">"could not extract source from repository"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Run user-defined deploy hooks (if any).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hooks deploy <span class="hljs-variable">$release_dir</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Link the <code>current</code> directory to the new release.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> linking current
  run <span class="hljs-string">"ln -fns <span class="hljs-variable">$release_dir</span> <span class="hljs-variable">$current_dir</span>"</span> \
    || abort <span class="hljs-string">"could not create current symlink"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Run user-defined post-deploy hooks (if any).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hooks post-deploy <span class="hljs-variable">$current_dir</span>

  <span class="hljs-built_in">log</span> successfully deployed
}</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h3 id="-env-config-key-"><code>[env] config [key]</code></h3>
<p>Prints configuration values.</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[]
user dev

[production]
user root
port 222
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">config</span></span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>If called with <strong>no environment and no arguments</strong>, print the whole configuration file:</p>
<pre><code class="lang-sh"><span class="hljs-comment"># shell</span>
deploy config
<span class="hljs-comment">#=&gt; []</span>
<span class="hljs-comment">#=&gt; user dev</span>
<span class="hljs-comment">#=&gt;</span>
<span class="hljs-comment">#=&gt; [production]</span>
<span class="hljs-comment">#=&gt; user root</span>
<span class="hljs-comment">#=&gt; port 222</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> <span class="hljs-variable">$#</span> -eq 0; <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_ENV</span>"</span>; <span class="hljs-keyword">then</span>
      cat <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CONFIG</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>If <strong>preceded by the environment</strong>, print all values in that section:</p>
<pre><code class="lang-sh"><span class="hljs-comment"># shell</span>
deploy production config
<span class="hljs-comment">#=&gt; user root</span>
<span class="hljs-comment">#=&gt; port 222</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span>
      get_config_section <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_ENV</span>"</span>
    <span class="hljs-keyword">fi</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>If called with <strong>the environment and a key</strong>, print the last value of that key in that section:</p>
<pre><code class="lang-sh"><span class="hljs-comment"># shell</span>
deploy production config user
<span class="hljs-comment">#=&gt; root</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span>
    get_last_config_value <span class="hljs-variable">$1</span>
  <span class="hljs-keyword">fi</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h3 id="-env-config-all-key-"><code>&lt;env&gt; config-all &lt;key&gt;</code></h3>
<p>Outputs all values of a config key in the current environment and its inherited environments.</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[]
user dev

[production]
user root
port 222
</code></pre><pre><code class="lang-sh"><span class="hljs-comment"># shell</span>
deploy production config-all user
<span class="hljs-comment">#=&gt; dev</span>
<span class="hljs-comment">#=&gt; root</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">config_all</span></span>() {
  get_all_config_values <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h3 id="-env-console-path-"><code>&lt;env&gt; console [path]</code></h3>
<p>Launches an interactive ssh console session.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">console</span></span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>If an <strong>absolute path</strong> is given, the session starts there.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> path=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>If <strong>no path</strong> is given, the session starts in the deployment directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span>; <span class="hljs-keyword">then</span>
    path=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_value path)</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>If a <strong>relative path</strong> is given, it starts there relative to the deployment directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">elif</span> [[ ! <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> =~ ^\/ ]]; <span class="hljs-keyword">then</span>
    path=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_value path)</span>/<span class="hljs-variable">$path</span>"</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> || abort <span class="hljs-string">"path is required"</span>

  <span class="hljs-built_in">local</span> shell=<span class="hljs-string">"`build_ssh_command`"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$shell</span>
  <span class="hljs-variable">$shell</span> -t <span class="hljs-string">"cd <span class="hljs-variable">$path</span>; \$SHELL -il"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h2 id="general-options">General options</h2>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h3 id="-config-path-"><code>--config &lt;path&gt;</code></h3>
<p><code>./deploy.conf</code> is used as the configuration file by default.
Use this option or the <code>$DEPLOY_CONFIG</code> environment variable to load a different file.</p>
<p>The option takes precedence over the environment variable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">set_config_path</span></span>() {
  <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> || abort <span class="hljs-string">"invalid --config &lt;path&gt; (no such file)"</span>
  DEPLOY_CONFIG=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h3 id="-version-"><code>--version</code></h3>
<p>Prints the current version and exits.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">version</span></span>() {
  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$VERSION</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h2 id="internal-implementation">Internal implementation</h2>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h3 id="-config_section_exists-env-"><code>config_section_exists $env</code></h3>
<p>Checks whether the config file contains a section with the specified name.
Returns a non-zero status code if it doesn’t.</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[development]
host example
</code></pre><pre><code class="lang-sh"><span class="hljs-comment"># script</span>
config_section_exists development
<span class="hljs-built_in">echo</span> $? <span class="hljs-comment">#=&gt; 0</span>
config_section_exists production
<span class="hljs-built_in">echo</span> $? <span class="hljs-comment">#=&gt; 1</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">config_section_exists</span></span>() {
  grep <span class="hljs-string">"^\[<span class="hljs-variable">$1</span>\]$"</span> <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CONFIG</span>"</span> &amp;&gt; /dev/null
}</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h3 id="-get_config_env_var-key-"><code>get_config_env_var $key</code></h3>
<p>Gets the environment variable that can be used to add
a value to the specified config key.</p>
<pre><code class="lang-sh"><span class="hljs-comment"># script</span>
get_config_env_var path
<span class="hljs-comment">#=&gt; DEPLOY_PATH</span>
get_config_env_var post-setup
<span class="hljs-comment">#=&gt; DEPLOY_POST_SETUP</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_config_env_var</span></span>() {
  <span class="hljs-built_in">local</span> key=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"DEPLOY_<span class="hljs-variable">$key</span>"</span> | tr <span class="hljs-string">'-'</span> <span class="hljs-string">'_'</span> | tr <span class="hljs-string">'[a-z]'</span> <span class="hljs-string">'[A-Z]'</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h3 id="-get_last_config_value-key-"><code>get_last_config_value $key</code></h3>
<p>Gets the last value of a config key in the current environment and its inherited environments.</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[]
user dev

[production]
user root
</code></pre><pre><code class="lang-sh"><span class="hljs-comment"># script</span>
get_last_config_value host production
<span class="hljs-comment">#=&gt; root</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_last_config_value</span></span>() {

  <span class="hljs-built_in">local</span> key=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">local</span> env_var=$(get_config_env_var <span class="hljs-variable">$key</span>)

  <span class="hljs-built_in">local</span> env_var_value=<span class="hljs-variable">${!env_var}</span>
  <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$env_var_value</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$env_var_value</span>"</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> \
      &amp;&amp; get_all_config_values <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> \
      | tail -n 1
  <span class="hljs-keyword">fi</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h3 id="-get_all_config_values-key-"><code>get_all_config_values $key</code></h3>
<p>Gets all values of a config key in the current environment and its inherited environments.</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[development]
deploy <span class="hljs-keyword">do</span>-stuff
deploy <span class="hljs-keyword">do</span>-more-stuff
deploy just-do-it
</code></pre><pre><code class="lang-sh"><span class="hljs-comment"># script</span>
get_all_config_values deploy development
<span class="hljs-comment">#=&gt; do-stuff</span>
<span class="hljs-comment">#=&gt; do-more-stuff</span>
<span class="hljs-comment">#=&gt; just-do-it</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_all_config_values</span></span>() {

  <span class="hljs-built_in">local</span> env=<span class="hljs-variable">$DEPLOY_ENV</span>
  <span class="hljs-built_in">local</span> key=<span class="hljs-variable">$1</span>

  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$env</span>"</span> \
    &amp;&amp; <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> \
    &amp;&amp; get_config_values_recursive <span class="hljs-variable">$key</span> <span class="hljs-variable">$env</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h3 id="-get_config_values_recursive-key-env-"><code>get_config_values_recursive $key $env</code></h3>
<p>Recursively gets all values of a config key for an environment and its inherited environments.
Used by <code>get_all_config_values</code>.</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[]
deploy <span class="hljs-keyword">do</span>-stuff

[common]
deploy <span class="hljs-keyword">do</span>-more-stuff
deploy <span class="hljs-keyword">do</span>-stuff-again

[shared]
inherits common
deploy <span class="hljs-keyword">do</span>-shared-stuff

[development]
inherits common
inherits shared
deploy just-do-it
</code></pre><pre><code class="lang-sh"><span class="hljs-comment"># script</span>
get_config_values_recursive deploy development
<span class="hljs-comment">#=&gt; do-stuff</span>
<span class="hljs-comment">#=&gt; do-more-stuff</span>
<span class="hljs-comment">#=&gt; do-stuff-again</span>
<span class="hljs-comment">#=&gt; just-do-it</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_config_values_recursive</span></span>() {

  <span class="hljs-built_in">local</span> key=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">local</span> env=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
  <span class="hljs-built_in">local</span> values=

  <span class="hljs-keyword">if</span> ! config_section_exists <span class="hljs-variable">$env</span>; <span class="hljs-keyword">then</span>
    echo_color <span class="hljs-variable">$COLOR_RED</span> <span class="hljs-string">"    [<span class="hljs-variable">$env</span>] config section not defined"</span> 1&gt;&amp;2
    <span class="hljs-built_in">exit</span> 0
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">local</span> new_line=$<span class="hljs-string">'\n'</span>
  <span class="hljs-built_in">local</span> old_ifs=<span class="hljs-variable">$IFS</span>
  IFS=$<span class="hljs-string">'\n'</span>

  <span class="hljs-built_in">local</span> inherits=<span class="hljs-string">"<span class="hljs-variable">$(get_config_values_in_env inherits $env)</span>"</span>
  <span class="hljs-keyword">for</span> inherit_env <span class="hljs-keyword">in</span> <span class="hljs-variable">$inherits</span>; <span class="hljs-keyword">do</span>
    IFS=<span class="hljs-string">"<span class="hljs-variable">$old_ifs</span>"</span>

    <span class="hljs-built_in">local</span> new_values=<span class="hljs-string">"<span class="hljs-variable">$(get_config_values_recursive $key $inherit_env)</span>"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$new_values</span>"</span>; <span class="hljs-keyword">then</span>
      [ -n <span class="hljs-string">"<span class="hljs-variable">$values</span>"</span> ] &amp;&amp; values=<span class="hljs-string">"<span class="hljs-variable">$values</span><span class="hljs-variable">$new_line</span>"</span>
      values=<span class="hljs-string">"<span class="hljs-variable">$values</span><span class="hljs-variable">$new_values</span>"</span>
    <span class="hljs-keyword">fi</span>

    IFS=$<span class="hljs-string">'\n'</span>
  <span class="hljs-keyword">done</span>

  IFS=<span class="hljs-string">"<span class="hljs-variable">$old_ifs</span>"</span>

  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$inherits</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">local</span> top_level_values=<span class="hljs-string">"<span class="hljs-variable">$(get_config_values_in_env $key)</span>"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$top_level_values</span>"</span>; <span class="hljs-keyword">then</span>
      [ -n <span class="hljs-string">"<span class="hljs-variable">$values</span>"</span> ] &amp;&amp; values=<span class="hljs-string">"<span class="hljs-variable">$new_line</span><span class="hljs-variable">$values</span>"</span>
      values=<span class="hljs-string">"<span class="hljs-variable">$top_level_values</span><span class="hljs-variable">$values</span>"</span>
    <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">local</span> current_level_values=<span class="hljs-string">"<span class="hljs-variable">$(get_config_values_in_env $key $env)</span>"</span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$current_level_values</span>"</span>; <span class="hljs-keyword">then</span>
    [ -n <span class="hljs-string">"<span class="hljs-variable">$values</span>"</span> ] &amp;&amp; values=<span class="hljs-string">"<span class="hljs-variable">$values</span><span class="hljs-variable">$new_line</span>"</span>
    values=<span class="hljs-string">"<span class="hljs-variable">$values</span><span class="hljs-variable">$current_level_values</span>"</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$values</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h3 id="-get_config_values_in_env-key-env-"><code>get_config_values_in_env $key $env</code></h3>
<p>Gets all values of a config key for an environment:</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[development]
host foo
port 42
host bar
</code></pre><pre><code class="lang-sh"><span class="hljs-comment"># script</span>
get_config_values_in_env host development
<span class="hljs-comment">#=&gt; foo</span>
<span class="hljs-comment">#=&gt; bar</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_config_values_in_env</span></span>() {

  <span class="hljs-built_in">local</span> key=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">local</span> env=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>

  get_config_section <span class="hljs-variable">$env</span> \
    | grep <span class="hljs-string">"^<span class="hljs-variable">$key</span> "</span> \
    | cut -d <span class="hljs-string">' '</span> -f 2-999
}</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h3 id="-get_config_section-env-"><code>get_config_section $env</code></h3>
<p>Gets all key/value pairs in a config section, with all comments and empty lines omitted:</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[development]

host foo
<span class="hljs-comment"># SSH port</span>
port 42
user dev
</code></pre><pre><code class="lang-sh"><span class="hljs-comment"># script</span>
get_config_section development
<span class="hljs-comment">#=&gt; host foo</span>
<span class="hljs-comment">#=&gt; port 42</span>
<span class="hljs-comment">#=&gt; user dev</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_config_section</span></span>() {

  <span class="hljs-built_in">local</span> env=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>

  grep <span class="hljs-string">"^\[<span class="hljs-variable">$env</span>\]$"</span> -A 999 <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CONFIG</span>"</span> \
    | tail -n +2 \
    | grep -v <span class="hljs-string">"^ *#"</span> \
    | grep -v <span class="hljs-string">"^ *$"</span> \
    | sed <span class="hljs-string">"/^\[/q"</span> \
    | sed <span class="hljs-string">"/^\[/d"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <h3 id="-build_ssh_command-"><code>build_ssh_command</code></h3>
<p>Builds an SSH command to connect to the host.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">build_ssh_command</span></span>() {
  <span class="hljs-built_in">local</span> host=$(get_last_config_value host)
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$host</span>"</span> || abort <span class="hljs-string">"no host config found in environment <span class="hljs-variable">$DEPLOY_ENV</span>"</span>

  <span class="hljs-built_in">local</span> url=<span class="hljs-variable">$host</span>

  <span class="hljs-built_in">local</span> user=$(get_last_config_value user)
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$user</span>"</span>; <span class="hljs-keyword">then</span>
    url=<span class="hljs-string">"<span class="hljs-variable">$user</span>@<span class="hljs-variable">$url</span>"</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">local</span> key=<span class="hljs-string">"`get_last_config_value key`"</span>
  <span class="hljs-built_in">local</span> forward_agent=<span class="hljs-string">"`get_last_config_value forward-agent`"</span>
  <span class="hljs-built_in">local</span> port=<span class="hljs-string">"`get_last_config_value port`"</span>
  <span class="hljs-built_in">local</span> needs_tty=<span class="hljs-string">"`get_last_config_value needs_tty`"</span>

  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$forward_agent</span>"</span> &amp;&amp; <span class="hljs-built_in">local</span> agent=<span class="hljs-string">"-A"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> &amp;&amp; <span class="hljs-built_in">local</span> identity=<span class="hljs-string">"-i <span class="hljs-variable">$key</span>"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$port</span>"</span> &amp;&amp; <span class="hljs-built_in">local</span> port=<span class="hljs-string">"-p <span class="hljs-variable">$port</span>"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$needs_tty</span>"</span> &amp;&amp; <span class="hljs-built_in">local</span> tty=<span class="hljs-string">"-t"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"ssh <span class="hljs-variable">$tty</span> <span class="hljs-variable">$agent</span> <span class="hljs-variable">$port</span> <span class="hljs-variable">$identity</span> <span class="hljs-variable">$url</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <h3 id="-echo_color-color-message-"><code>echo_color $color $message</code></h3>
<p>Prints a message in the specified color.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">echo_color</span></span>() {
  <span class="hljs-built_in">local</span> color=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">shift</span>
  <span class="hljs-built_in">local</span> message=<span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
  <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\033[<span class="hljs-variable">${color}</span>m<span class="hljs-variable">${message}</span>\033[0m"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <h3 id="-run-"><code>run $@</code></h3>
<p>Runs the specified command on the host through SSH.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">run</span></span>() {
  <span class="hljs-built_in">local</span> shell=<span class="hljs-string">"`build_ssh_command`"</span>
  echo_color 33 <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span> | tr -s <span class="hljs-string">' '</span> | sed <span class="hljs-string">'s/^/    /'</span>
  <span class="hljs-variable">$shell</span> <span class="hljs-variable">$@</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Returns the command used to export the user’s environment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">env_command</span></span>() {
  <span class="hljs-built_in">local</span> path=`get_last_config_value path`
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"export ROOT_DIR=<span class="hljs-variable">$path</span> <span class="hljs-variable">$(env_variables)</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">env_variables</span></span>() {
  <span class="hljs-built_in">local</span> env=<span class="hljs-string">"<span class="hljs-variable">$(echo `get_all_config_values env`|sed 's/\n/ /g')</span>"</span>

  <span class="hljs-keyword">for</span> forward_env <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">echo</span> `get_all_config_values forward-env`|sed <span class="hljs-string">'s/\n/ /g'</span>); <span class="hljs-keyword">do</span>
    env=<span class="hljs-string">"<span class="hljs-variable">$env</span> <span class="hljs-variable">$forward_env</span>=<span class="hljs-variable">$(echo "${!forward_env}"|sed 's/ /\\ /g')</span>"</span>
  <span class="hljs-keyword">done</span>

  <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$env</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Execute hook(s) <name> relative to the path configured</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">hooks</span></span>() {

  <span class="hljs-built_in">local</span> hook=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$hook</span>"</span> || abort hook name required

  <span class="hljs-built_in">local</span> dir=<span class="hljs-variable">$2</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span> || abort working directory required

  <span class="hljs-built_in">local</span> path=`get_last_config_value path`
  <span class="hljs-built_in">local</span> commands=`get_all_config_values <span class="hljs-variable">$hook</span>`

  <span class="hljs-built_in">log</span> hook <span class="hljs-variable">$hook</span>

  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$commands</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">local</span> old_ifs=<span class="hljs-variable">$IFS</span>
    IFS=$<span class="hljs-string">'\n'</span>

    <span class="hljs-keyword">for</span> cmd <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$commands</span>"</span>); <span class="hljs-keyword">do</span>
      IFS=<span class="hljs-string">"<span class="hljs-variable">$old_ifs</span>"</span>

      run <span class="hljs-string">"cd <span class="hljs-variable">$dir</span> \
           &amp;&amp; export ROOT_DIR=<span class="hljs-variable">$path</span> <span class="hljs-variable">$(env_variables)</span> \
           &amp;&amp; <span class="hljs-variable">$cmd</span> 2&gt;&amp;1"</span> \
        || abort <span class="hljs-variable">$hook</span> hook failed

      IFS=$<span class="hljs-string">'\n'</span>
    <span class="hljs-keyword">done</span>

    IFS=<span class="hljs-string">"<span class="hljs-variable">$old_ifs</span>"</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"    nothing to do"</span>
  <span class="hljs-keyword">fi</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>List deploys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">list_deploys</span></span>() {
  <span class="hljs-built_in">local</span> path=`get_last_config_value path`
  run <span class="hljs-string">"ls -1 <span class="hljs-variable">$path</span>/releases"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Require environment arg</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">require_env</span></span>() {
  <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_ENV</span>"</span> &amp;&amp; abort <span class="hljs-string">"&lt;env&gt; required"</span>
  config_section_exists <span class="hljs-variable">$DEPLOY_ENV</span> || abort <span class="hljs-string">"[<span class="hljs-variable">$DEPLOY_ENV</span>] config section not defined"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Ensure all changes are committed and pushed before deploying</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">check_for_local_changes</span></span>() {
  git --no-pager diff --<span class="hljs-built_in">exit</span>-code --quiet || abort <span class="hljs-string">"commit or stash your changes before deploying"</span>
  git --no-pager diff --<span class="hljs-built_in">exit</span>-code --quiet --cached || abort <span class="hljs-string">"commit your staged changes before deploying"</span>
  [ -z <span class="hljs-string">"`git rev-list @{upstream}.. -n 1`"</span> ] || abort <span class="hljs-string">"push your changes before deploying"</span>
}

<span class="hljs-function"><span class="hljs-title">deploy_tmp</span></span>() {
  DEPLOY_TMP_DIR=<span class="hljs-string">"<span class="hljs-variable">$(mktemp -d -t deploy)</span>"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_TMP_DIR</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">update</span></span>() {
  <span class="hljs-built_in">log</span> <span class="hljs-string">"updating deploy from <span class="hljs-variable">$UPDATE_REPO</span>"</span>

  <span class="hljs-built_in">local</span> tmp_dir=`deploy_tmp`
  <span class="hljs-built_in">cd</span> <span class="hljs-string">"<span class="hljs-variable">$tmp_dir</span>"</span> \
    &amp;&amp; git <span class="hljs-built_in">clone</span> <span class="hljs-variable">$UPDATE_REPO</span> <span class="hljs-string">"<span class="hljs-variable">$tmp_dir</span>"</span> \
    &amp;&amp; make install \
    || abort could not update deploy

  <span class="hljs-built_in">log</span> <span class="hljs-string">"updated <span class="hljs-variable">$VERSION</span> -&gt; `./bin/deploy --version`"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Abort with <msg></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">abort</span></span>() {
  <span class="hljs-built_in">echo</span>
  echo_color <span class="hljs-variable">$COLOR_RED</span> <span class="hljs-string">"  <span class="hljs-variable">$@</span>"</span> 1&gt;&amp;2
  <span class="hljs-built_in">echo</span>
  <span class="hljs-built_in">exit</span> 1
}

<span class="hljs-function"><span class="hljs-title">cleanup</span></span>() {
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_TMP_DIR</span>"</span> &amp;&amp; <span class="hljs-built_in">test</span> -d <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_TMP_DIR</span>"</span> &amp;&amp; rm -fr <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_TMP_DIR</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Log <msg></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">log</span></span>() {
  <span class="hljs-built_in">echo</span>
  echo_color <span class="hljs-variable">$COLOR_BOLD</span> <span class="hljs-string">"  ○ <span class="hljs-variable">$@</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">main</span></span>() {
  <span class="hljs-built_in">trap</span> cleanup EXIT</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Source environment file if present</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  [ -f .env ] &amp;&amp; . .env

  COLOR_BOLD=1
  COLOR_RED=31
  COLOR_YELLOW=33

  VERSION=<span class="hljs-string">"1.0.1"</span>
  DEPLOY_ENV=

  UPDATE_REPO=git://github.com/AlphaHydrae/deploy.git
  DEPLOY_TMP_DIR=

  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CONFIG</span>"</span>; <span class="hljs-keyword">then</span>
    DEPLOY_CONFIG=./deploy.conf
  <span class="hljs-keyword">fi</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Parse arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">while</span> <span class="hljs-built_in">test</span> <span class="hljs-variable">$#</span> -ne 0; <span class="hljs-keyword">do</span>
    arg=<span class="hljs-variable">$1</span>; <span class="hljs-built_in">shift</span>
    <span class="hljs-keyword">case</span> <span class="hljs-variable">$arg</span> <span class="hljs-keyword">in</span>
      -h|--<span class="hljs-built_in">help</span>) usage; <span class="hljs-built_in">exit</span> ;;
      -V|--version) version; <span class="hljs-built_in">exit</span> ;;
      -c|--config) set_config_path <span class="hljs-variable">$1</span>; <span class="hljs-built_in">shift</span> ;;
      -C|--<span class="hljs-built_in">chdir</span>) <span class="hljs-built_in">log</span> <span class="hljs-built_in">cd</span> <span class="hljs-variable">$1</span>; <span class="hljs-built_in">cd</span> <span class="hljs-variable">$1</span>; <span class="hljs-built_in">shift</span> ;;
      <span class="hljs-built_in">exec</span>) require_env; run <span class="hljs-string">"cd `get_last_config_value path`/current &amp;&amp; <span class="hljs-variable">$(env_command)</span> &amp;&amp; <span class="hljs-variable">$@</span>"</span>; <span class="hljs-built_in">exit</span> ;;
      console) require_env; console <span class="hljs-variable">$1</span>; <span class="hljs-built_in">exit</span> ;;
      setup) require_env; setup <span class="hljs-variable">$@</span>; <span class="hljs-built_in">exit</span> ;;
      list) require_env; list_deploys; <span class="hljs-built_in">exit</span> ;;
      ref) require_env; check_for_local_changes; deploy_ref <span class="hljs-variable">$1</span>; <span class="hljs-built_in">exit</span> ;;
      update) update; <span class="hljs-built_in">exit</span> ;;
      config) config <span class="hljs-variable">$@</span>; <span class="hljs-built_in">exit</span> ;;
      config-all) require_env; config_all <span class="hljs-variable">$@</span>; <span class="hljs-built_in">exit</span>;;
      *)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_ENV</span>"</span>; <span class="hljs-keyword">then</span>
          DEPLOY_ENV=<span class="hljs-variable">$arg</span>;
        <span class="hljs-keyword">else</span>
          abort <span class="hljs-string">"unknown command or option <span class="hljs-variable">$arg</span>"</span>
        <span class="hljs-keyword">fi</span>
        ;;
    <span class="hljs-keyword">esac</span>
  <span class="hljs-keyword">done</span>

  usage
  abort <span class="hljs-string">"no command given"</span>
}

main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script><script>
$(function() {
  $('ul.sections li').not('#title').filter(function() {
    return $(this).find('.annotation h2, .annotation h3').length;
  }).addClass('title');
});
</script></body>
</html>
