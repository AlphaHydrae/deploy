<!DOCTYPE html>

<html>
<head>
  <title>deploy</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>deploy</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">#!/usr/bin/env bash

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><strong><em>A shell script to deploy Git repositories.</em></strong></p>
<ul>
<li><strong>Source:</strong> <a href="https://github.com/AlphaHydrae/deploy">https://github.com/AlphaHydrae/deploy</a></li>
<li><strong>Originally by:</strong> <a href="https://github.com/visionmedia/deploy">https://github.com/visionmedia/deploy</a></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
VERSION=<span class="hljs-string">"1.0.1"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="usage">Usage</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">usage</span></span>() {
  cat &lt;&lt;-EOF

  Usage: deploy [options] &lt;env&gt; &lt;<span class="hljs-built_in">command</span>&gt;

  Options:

    -C, --<span class="hljs-built_in">chdir</span> &lt;path&gt;    change the working directory to &lt;path&gt;
    -c, --config &lt;path&gt;   <span class="hljs-built_in">set</span> config path. defaults to ./deploy.conf
    -V, --version         output program version
    -h, --<span class="hljs-built_in">help</span>            output <span class="hljs-built_in">help</span> information

  Commands:

    &lt;env&gt; setup              run remote setup commands
    &lt;env&gt; ref [ref]          deploy a release (commit, branch or tag)
    [env] config [key]       output config file, a section, or one value
    &lt;env&gt; config-all [key]   output all values of a config key <span class="hljs-keyword">in</span> an environment
    &lt;env&gt; console [path]     open an ssh session to the host
    &lt;env&gt; <span class="hljs-built_in">exec</span> &lt;cmd&gt;         execute the given <span class="hljs-built_in">command</span> on the host
    &lt;env&gt; list               list previous deploy commits
    update                   update this script to the latest version

  Examples:

    deploy prod setup             run remote setup <span class="hljs-keyword">in</span> the prod env
    deploy dev ref master         deploy the master branch <span class="hljs-keyword">in</span> the dev env
    deploy prod <span class="hljs-built_in">exec</span> pm2 status   run <span class="hljs-string">'pm2 status'</span> <span class="hljs-keyword">in</span> the prod env
    deploy dev config user        get the value of the user key <span class="hljs-keyword">in</span> the dev env

EOF
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="sub-commands">Sub-commands</h2>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h3 id="-env-setup-"><code>&lt;env&gt; setup</code></h3>
<p>Perform first-time setup tasks before deployment.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">setup</span></span>() {
  require_env

  <span class="hljs-built_in">local</span> path=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_value path)</span>"</span>
  <span class="hljs-built_in">local</span> repo=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_value repo)</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Run user-defined <code>pre-setup</code> hooks (if any).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run_hooks pre-setup <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Create the <code>releases</code> and <code>tmp</code> directories in the deployment directory
if they don’t already exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> running setup
  run <span class="hljs-string">"{ test -d <span class="hljs-variable">$path</span> || exit 1; } \
       &amp;&amp; mkdir -p <span class="hljs-variable">$path</span>/releases <span class="hljs-variable">$path</span>/tmp"</span> \
    || abort <span class="hljs-string">"failed to set up directories; make sure <span class="hljs-variable">$path</span> exists and is writable"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Clone the repository into <code>repo</code> in the deployment directory
if it isn’t already there.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> cloning repo
  run <span class="hljs-string">"test -d <span class="hljs-variable">$path</span>/repo \
       || { git clone --bare <span class="hljs-variable">$repo</span> <span class="hljs-variable">$path</span>/repo || exit 1; }"</span> \
    || abort <span class="hljs-string">"failed to clone repo"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Run user-defined <code>post-setup</code> hooks (if any).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run_hooks post-setup <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span>

  <span class="hljs-built_in">log</span> setup complete
}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3 id="-env-ref-ref-"><code>&lt;env&gt; ref [ref]</code></h3>
<p>Deploys the latest changes from the repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">deploy_ref</span></span>() {
  require_env
  require_no_local_changes

  <span class="hljs-built_in">local</span> path=`get_last_config_value path`
  <span class="hljs-built_in">local</span> release=`date -u <span class="hljs-string">'+%Y-%m-%d-%H-%M-%S'</span>`
  <span class="hljs-built_in">local</span> current_dir=<span class="hljs-string">"<span class="hljs-variable">$path</span>/current"</span>
  <span class="hljs-built_in">local</span> release_dir=<span class="hljs-string">"<span class="hljs-variable">$path</span>/releases/<span class="hljs-variable">$release</span>"</span>
  <span class="hljs-built_in">local</span> tmp_dir=<span class="hljs-string">"<span class="hljs-variable">$path</span>/tmp"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>A Git reference to a commit, branch or tag is required,
either from the command line argument or from a <code>ref</code> key in the configuration file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> ref=<span class="hljs-variable">${1:-`get_last_config_value ref`}</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$ref</span>"</span> || abort <span class="hljs-string">"no commit, branch or tag specified"</span>

  <span class="hljs-built_in">log</span> deploying
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"    ref: <span class="hljs-variable">$ref</span>"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"    release: <span class="hljs-variable">$release</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Run user-defined pre-deploy hooks (if any).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run_hooks pre-deploy <span class="hljs-variable">$current_dir</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Fetch the latest changes from the repository (from the specified ref).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> fetching updates
  run <span class="hljs-string">"cd <span class="hljs-variable">$path</span>/repo \
       &amp;&amp; git fetch origin '+refs/heads/*:refs/heads/*' \
       &amp;&amp; git rev-list -n 1 <span class="hljs-variable">$ref</span>"</span> \
    || abort <span class="hljs-string">"could not fetch changes"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Extract the sources at the specified ref into the <code>releases</code> directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> <span class="hljs-string">"extracting source at <span class="hljs-variable">$ref</span>"</span>
  run <span class="hljs-string">"cd <span class="hljs-variable">$path</span>/repo \
       &amp;&amp; mkdir -p <span class="hljs-variable">$release_dir</span> \
       &amp;&amp; git archive --output <span class="hljs-variable">$tmp_dir</span>/release-<span class="hljs-variable">$release</span>.tar <span class="hljs-variable">$ref</span> \
       &amp;&amp; tar -C <span class="hljs-variable">$release_dir</span> -x --file <span class="hljs-variable">$tmp_dir</span>/release-<span class="hljs-variable">$release</span>.tar \
       &amp;&amp; rm -f <span class="hljs-variable">$tmp_dir</span>/release-*.tar"</span> \
    || abort <span class="hljs-string">"could not extract source from repository"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Run user-defined deploy hooks (if any).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run_hooks deploy <span class="hljs-variable">$release_dir</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Link the <code>current</code> directory to the new release.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> linking current
  run <span class="hljs-string">"ln -fns <span class="hljs-variable">$release_dir</span> <span class="hljs-variable">$current_dir</span>"</span> \
    || abort <span class="hljs-string">"could not create current symlink"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Run user-defined post-deploy hooks (if any).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run_hooks post-deploy <span class="hljs-variable">$current_dir</span>

  <span class="hljs-built_in">log</span> successfully deployed
}</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h3 id="-env-config-key-"><code>[env] config [key]</code></h3>
<p>Prints configuration values.</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[]
user dev

[production]
user root
port 222
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">config</span></span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>If called with <strong>no environment and no arguments</strong>, print the whole configuration file:</p>
<pre><code class="lang-sh"><span class="hljs-comment"># shell</span>
deploy config
<span class="hljs-comment">#=&gt; []</span>
<span class="hljs-comment">#=&gt; user dev</span>
<span class="hljs-comment">#=&gt;</span>
<span class="hljs-comment">#=&gt; [production]</span>
<span class="hljs-comment">#=&gt; user root</span>
<span class="hljs-comment">#=&gt; port 222</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> <span class="hljs-variable">$#</span> -eq 0; <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_ENV</span>"</span>; <span class="hljs-keyword">then</span>
      cat <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CONFIG</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>If <strong>preceded by the environment</strong>, print all values in that section:</p>
<pre><code class="lang-sh"><span class="hljs-comment"># shell</span>
deploy production config
<span class="hljs-comment">#=&gt; user root</span>
<span class="hljs-comment">#=&gt; port 222</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span>
      get_config_section <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_ENV</span>"</span>
    <span class="hljs-keyword">fi</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>If called with <strong>the environment and a key</strong>, print the last value of that key in that section:</p>
<pre><code class="lang-sh"><span class="hljs-comment"># shell</span>
deploy production config user
<span class="hljs-comment">#=&gt; root</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span>
    get_last_config_value <span class="hljs-variable">$1</span>
  <span class="hljs-keyword">fi</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h3 id="-env-config-all-key-"><code>&lt;env&gt; config-all &lt;key&gt;</code></h3>
<p>Outputs all values of a config key in the current environment and its inherited environments.</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[]
user dev

[production]
user root
port 222
</code></pre><pre><code class="lang-sh"><span class="hljs-comment"># shell</span>
deploy production config-all user
<span class="hljs-comment">#=&gt; dev</span>
<span class="hljs-comment">#=&gt; root</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">config_all</span></span>() {
  require_env
  get_all_config_values <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h3 id="-env-console-path-"><code>&lt;env&gt; console [path]</code></h3>
<p>Launches an interactive ssh console session.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">console</span></span>() {
  require_env</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>If an <strong>absolute path</strong> is given, the session starts there.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> path=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>If <strong>no path</strong> is given, the session starts in the deployment directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span>; <span class="hljs-keyword">then</span>
    path=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_value path)</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>If a <strong>relative path</strong> is given, it starts there relative to the deployment directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">elif</span> [[ ! <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> =~ ^\/ ]]; <span class="hljs-keyword">then</span>
    path=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_value path)</span>/<span class="hljs-variable">$path</span>"</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> || abort <span class="hljs-string">"path is required"</span>

  <span class="hljs-built_in">local</span> shell=<span class="hljs-string">"`build_ssh_command`"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$shell</span>
  <span class="hljs-variable">$shell</span> -t <span class="hljs-string">"cd <span class="hljs-variable">$path</span>; \$SHELL -il"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h3 id="-env-exec-cmd-"><code>&lt;env&gt; exec &lt;cmd&gt;</code></h3>
<p>Executes the specified command on the host.</p>
<pre><code class="lang-sh">deploy production <span class="hljs-built_in">exec</span> ps -ef
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">exec_remote_command</span></span>() {
  require_env
  <span class="hljs-built_in">local</span> path=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_value path)</span>"</span>
  run <span class="hljs-string">"cd <span class="hljs-variable">$path</span> &amp;&amp; <span class="hljs-variable">$(build_export_env_command)</span> &amp;&amp; <span class="hljs-variable">$@</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h3 id="-env-list-"><code>&lt;env&gt; list</code></h3>
<p>Lists the releases that have been deployed on the host.</p>
<pre><code class="lang-sh">$&gt; deploy production list
2016-12-24-17-45-23
2017-01-01-02-03-43
2017-04-01-00-00-00
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">list_releases</span></span>() {
  require_env
  <span class="hljs-built_in">local</span> path=`get_last_config_value path`
  run <span class="hljs-string">"ls -1 <span class="hljs-variable">$path</span>/releases"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h3 id="-update-prefix-dir-path-path-ref-"><code>update [--prefix dir] [--path path] [ref]</code></h3>
<p>Updates this script to the latest version by downloading it from the Git repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">update_self</span></span>() {
  <span class="hljs-built_in">local</span> ref=
  <span class="hljs-built_in">local</span> path=
  <span class="hljs-built_in">local</span> prefix=/usr/<span class="hljs-built_in">local</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>This sub-command requires additional shell commands to be available.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  require_command chmod cp mktemp

  <span class="hljs-keyword">while</span> <span class="hljs-built_in">test</span> <span class="hljs-variable">$#</span> -ne 0; <span class="hljs-keyword">do</span>
    arg=<span class="hljs-variable">$1</span>; <span class="hljs-built_in">shift</span>
    <span class="hljs-keyword">case</span> <span class="hljs-variable">$arg</span> <span class="hljs-keyword">in</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>If a <code>--prefix</code> directory is specified, the script will be installed
at <code>bin/deploy</code> relative to that directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      --prefix) prefix=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>; <span class="hljs-built_in">shift</span> ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>If a <code>--path</code> file is specified, the script will be installed there
(this overrides the <code>--prefix</code> option).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      --path) path=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>; <span class="hljs-built_in">shift</span> ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>The first optional argument is the Git revision from which to download the script.
This defaults to <code>master</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      *)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$ref</span>"</span>; <span class="hljs-keyword">then</span>
          ref=<span class="hljs-string">"<span class="hljs-variable">$arg</span>"</span>
        <span class="hljs-keyword">else</span>
          abort <span class="hljs-string">"unknown command or option <span class="hljs-variable">$arg</span>"</span>
        <span class="hljs-keyword">fi</span>
        ;;
    <span class="hljs-keyword">esac</span>
  <span class="hljs-keyword">done</span>

  <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> &amp;&amp; path=<span class="hljs-variable">$prefix</span>/bin/deploy</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>The installation path must be a writable file or not exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">test</span> -e <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> &amp;&amp; ! <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> &amp;&amp; abort <span class="hljs-string">"<span class="hljs-variable">$path</span> already exists and is not a file"</span>
  <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> &amp;&amp; ! <span class="hljs-built_in">test</span> -w <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> &amp;&amp; abort <span class="hljs-string">"<span class="hljs-variable">$path</span> is not writable"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>If the installation path does not already exist, its parent must be a writable directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> dir=<span class="hljs-string">"<span class="hljs-variable">$(dirname "$path")</span>"</span>
  <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> || <span class="hljs-built_in">test</span> -e <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span> || abort <span class="hljs-string">"<span class="hljs-variable">$dir</span> does not exist"</span>
  <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> || <span class="hljs-built_in">test</span> -d <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span> || abort <span class="hljs-string">"<span class="hljs-variable">$dir</span> is not a directory"</span>
  <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> || <span class="hljs-built_in">test</span> -w <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> || abort <span class="hljs-string">"<span class="hljs-variable">$dir</span> is not writable"</span>

  <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$ref</span>"</span> &amp;&amp; ref=master
  <span class="hljs-built_in">log</span> <span class="hljs-string">"updating deploy from <span class="hljs-variable">$ref</span> @ <span class="hljs-variable">$DEPLOY_UPDATE_REPO</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>The Git repository is downloaded in a temporary directory that will be cleaned up when the update is done (or fails).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> tmp_dir=`mktemp -d -t deploy`
  <span class="hljs-built_in">trap</span> <span class="hljs-string">"cleanup <span class="hljs-variable">$tmp_dir</span>"</span> EXIT</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Once the Git directory is cloned, the correct revision of the script is copied to the installation path and made executable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">cd</span> <span class="hljs-string">"<span class="hljs-variable">$tmp_dir</span>"</span> \
    &amp;&amp; git <span class="hljs-built_in">clone</span> <span class="hljs-variable">$DEPLOY_UPDATE_REPO</span> <span class="hljs-string">"<span class="hljs-variable">$tmp_dir</span>"</span> || abort could not <span class="hljs-built_in">clone</span> <span class="hljs-variable">$DEPLOY_UPDATE_REPO</span> \
    &amp;&amp; { git rev-parse --verify <span class="hljs-variable">$ref</span> &amp;&gt;/dev/null &amp;&amp; git reset --hard <span class="hljs-variable">$ref</span> || { git fetch origin <span class="hljs-variable">$ref</span> &amp;&amp; git reset --hard origin/<span class="hljs-variable">$ref</span>; }; } || abort could not find <span class="hljs-variable">$ref</span> \
    &amp;&amp; cp bin/deploy <span class="hljs-variable">$path</span> \
    &amp;&amp; chmod +x /usr/<span class="hljs-built_in">local</span>/bin/deploy \
    || abort could not update deploy

  <span class="hljs-built_in">log</span> <span class="hljs-string">"updated <span class="hljs-variable">$VERSION</span> -&gt; `./bin/deploy --version`"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <h2 id="general-options">General options</h2>

            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <h3 id="-config-path-"><code>--config &lt;path&gt;</code></h3>
<p><code>./deploy.conf</code> is used as the configuration file by default.
Use this option or the <code>$DEPLOY_CONFIG</code> environment variable to load a different file.</p>
<p>The command line option takes precedence over the environment variable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">set_config_path</span></span>() {
  <span class="hljs-built_in">local</span> file=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">test</span> -e <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> || abort <span class="hljs-string">"invalid config file: <span class="hljs-variable">$file</span> does not exist"</span>
  <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> || abort <span class="hljs-string">"invalid config file: <span class="hljs-variable">$file</span> is not a file"</span>
  <span class="hljs-built_in">test</span> -r <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> || abort <span class="hljs-string">"invalid config file: <span class="hljs-variable">$file</span> cannot be read"</span>
  DEPLOY_CONFIG=<span class="hljs-string">"<span class="hljs-variable">$file</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <h3 id="-version-"><code>--version</code></h3>
<p>Prints the current version and exits.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">version</span></span>() {
  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$VERSION</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <h2 id="internal-implementation">Internal implementation</h2>

            </div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <h3 id="-config_section_exists-env-"><code>config_section_exists $env</code></h3>
<p>Checks whether the config file contains a section with the specified name.
Returns a non-zero status code if it doesn’t.</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[development]
host example
</code></pre><pre><code class="lang-sh"><span class="hljs-comment"># script</span>
config_section_exists development
<span class="hljs-built_in">echo</span> $? <span class="hljs-comment">#=&gt; 0</span>
config_section_exists production
<span class="hljs-built_in">echo</span> $? <span class="hljs-comment">#=&gt; 1</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">config_section_exists</span></span>() {
  grep <span class="hljs-string">"^\[<span class="hljs-variable">$1</span>\]$"</span> <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CONFIG</span>"</span> &amp;&gt; /dev/null
}</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <h3 id="-get_config_env_var-key-"><code>get_config_env_var $key</code></h3>
<p>Gets the environment variable that can be used to add
a value to the specified config key.</p>
<pre><code class="lang-sh"><span class="hljs-comment"># script</span>
get_config_env_var path
<span class="hljs-comment">#=&gt; DEPLOY_PATH</span>
get_config_env_var post-setup
<span class="hljs-comment">#=&gt; DEPLOY_POST_SETUP</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_config_env_var</span></span>() {
  <span class="hljs-built_in">local</span> key=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"DEPLOY_<span class="hljs-variable">$key</span>"</span> | tr <span class="hljs-string">'-'</span> <span class="hljs-string">'_'</span> | tr <span class="hljs-string">'[a-z]'</span> <span class="hljs-string">'[A-Z]'</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <h3 id="-get_last_config_value-key-"><code>get_last_config_value $key</code></h3>
<p>Gets the last value of a config key in the current environment and its inherited environments.</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[]
user dev

[production]
user root
</code></pre><pre><code class="lang-sh"><span class="hljs-comment"># script</span>
get_last_config_value host production
<span class="hljs-comment">#=&gt; root</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_last_config_value</span></span>() {

  <span class="hljs-built_in">local</span> key=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">local</span> env_var=$(get_config_env_var <span class="hljs-variable">$key</span>)

  <span class="hljs-built_in">local</span> env_var_value=<span class="hljs-variable">${!env_var}</span>
  <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$env_var_value</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$env_var_value</span>"</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> \
      &amp;&amp; get_all_config_values <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> \
      | tail -n 1
  <span class="hljs-keyword">fi</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h3 id="-get_all_config_values-key-"><code>get_all_config_values $key</code></h3>
<p>Gets all values of a config key in the current environment and its inherited environments.</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[development]
deploy <span class="hljs-keyword">do</span>-stuff
deploy <span class="hljs-keyword">do</span>-more-stuff
deploy just-do-it
</code></pre><pre><code class="lang-sh"><span class="hljs-comment"># script</span>
get_all_config_values deploy development
<span class="hljs-comment">#=&gt; do-stuff</span>
<span class="hljs-comment">#=&gt; do-more-stuff</span>
<span class="hljs-comment">#=&gt; just-do-it</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_all_config_values</span></span>() {

  <span class="hljs-built_in">local</span> env=<span class="hljs-variable">$DEPLOY_ENV</span>
  <span class="hljs-built_in">local</span> key=<span class="hljs-variable">$1</span>

  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$env</span>"</span> \
    &amp;&amp; <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> \
    &amp;&amp; get_config_values_recursive <span class="hljs-variable">$key</span> <span class="hljs-variable">$env</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h3 id="-get_config_values_recursive-key-env-"><code>get_config_values_recursive $key $env</code></h3>
<p>Recursively gets all values of a config key for an environment and its inherited environments.
Used by <code>get_all_config_values</code>.</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[]
deploy <span class="hljs-keyword">do</span>-stuff

[common]
deploy <span class="hljs-keyword">do</span>-more-stuff
deploy <span class="hljs-keyword">do</span>-stuff-again

[shared]
inherits common
deploy <span class="hljs-keyword">do</span>-shared-stuff

[development]
inherits common
inherits shared
deploy just-do-it
</code></pre><pre><code class="lang-sh"><span class="hljs-comment"># script</span>
get_config_values_recursive deploy development
<span class="hljs-comment">#=&gt; do-stuff</span>
<span class="hljs-comment">#=&gt; do-more-stuff</span>
<span class="hljs-comment">#=&gt; do-stuff-again</span>
<span class="hljs-comment">#=&gt; just-do-it</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_config_values_recursive</span></span>() {

  <span class="hljs-built_in">local</span> key=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">local</span> env=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
  <span class="hljs-built_in">local</span> values=

  <span class="hljs-keyword">if</span> ! config_section_exists <span class="hljs-variable">$env</span>; <span class="hljs-keyword">then</span>
    log_error <span class="hljs-string">"    [<span class="hljs-variable">$env</span>] config section not defined"</span>
    <span class="hljs-built_in">exit</span> 0
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">local</span> new_line=$<span class="hljs-string">'\n'</span>
  <span class="hljs-built_in">local</span> old_ifs=<span class="hljs-variable">$IFS</span>
  IFS=$<span class="hljs-string">'\n'</span>

  <span class="hljs-built_in">local</span> inherits=<span class="hljs-string">"<span class="hljs-variable">$(get_config_values_in_env inherits $env)</span>"</span>
  <span class="hljs-keyword">for</span> inherit_env <span class="hljs-keyword">in</span> <span class="hljs-variable">$inherits</span>; <span class="hljs-keyword">do</span>
    IFS=<span class="hljs-string">"<span class="hljs-variable">$old_ifs</span>"</span>

    <span class="hljs-built_in">local</span> new_values=<span class="hljs-string">"<span class="hljs-variable">$(get_config_values_recursive $key $inherit_env)</span>"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$new_values</span>"</span>; <span class="hljs-keyword">then</span>
      [ -n <span class="hljs-string">"<span class="hljs-variable">$values</span>"</span> ] &amp;&amp; values=<span class="hljs-string">"<span class="hljs-variable">$values</span><span class="hljs-variable">$new_line</span>"</span>
      values=<span class="hljs-string">"<span class="hljs-variable">$values</span><span class="hljs-variable">$new_values</span>"</span>
    <span class="hljs-keyword">fi</span>

    IFS=$<span class="hljs-string">'\n'</span>
  <span class="hljs-keyword">done</span>

  IFS=<span class="hljs-string">"<span class="hljs-variable">$old_ifs</span>"</span>

  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$inherits</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">local</span> top_level_values=<span class="hljs-string">"<span class="hljs-variable">$(get_config_values_in_env $key)</span>"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$top_level_values</span>"</span>; <span class="hljs-keyword">then</span>
      [ -n <span class="hljs-string">"<span class="hljs-variable">$values</span>"</span> ] &amp;&amp; values=<span class="hljs-string">"<span class="hljs-variable">$new_line</span><span class="hljs-variable">$values</span>"</span>
      values=<span class="hljs-string">"<span class="hljs-variable">$top_level_values</span><span class="hljs-variable">$values</span>"</span>
    <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">local</span> current_level_values=<span class="hljs-string">"<span class="hljs-variable">$(get_config_values_in_env $key $env)</span>"</span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$current_level_values</span>"</span>; <span class="hljs-keyword">then</span>
    [ -n <span class="hljs-string">"<span class="hljs-variable">$values</span>"</span> ] &amp;&amp; values=<span class="hljs-string">"<span class="hljs-variable">$values</span><span class="hljs-variable">$new_line</span>"</span>
    values=<span class="hljs-string">"<span class="hljs-variable">$values</span><span class="hljs-variable">$current_level_values</span>"</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$values</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <h3 id="-get_config_values_in_env-key-env-"><code>get_config_values_in_env $key $env</code></h3>
<p>Gets all values of a config key for an environment:</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[development]
host foo
port 42
host bar
</code></pre><pre><code class="lang-sh"><span class="hljs-comment"># script</span>
get_config_values_in_env host development
<span class="hljs-comment">#=&gt; foo</span>
<span class="hljs-comment">#=&gt; bar</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_config_values_in_env</span></span>() {

  <span class="hljs-built_in">local</span> key=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">local</span> env=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>

  get_config_section <span class="hljs-variable">$env</span> \
    | grep <span class="hljs-string">"^<span class="hljs-variable">$key</span> "</span> \
    | cut -d <span class="hljs-string">' '</span> -f 2-999
}</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <h3 id="-get_config_section-env-"><code>get_config_section $env</code></h3>
<p>Gets all key/value pairs in a config section, with all comments and empty lines omitted:</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[development]

host foo
<span class="hljs-comment"># SSH port</span>
port 42
user dev
</code></pre><pre><code class="lang-sh"><span class="hljs-comment"># script</span>
get_config_section development
<span class="hljs-comment">#=&gt; host foo</span>
<span class="hljs-comment">#=&gt; port 42</span>
<span class="hljs-comment">#=&gt; user dev</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_config_section</span></span>() {

  <span class="hljs-built_in">local</span> env=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>

  grep <span class="hljs-string">"^\[<span class="hljs-variable">$env</span>\]$"</span> -A 999 <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CONFIG</span>"</span> \
    | tail -n +2 \
    | grep -v <span class="hljs-string">"^ *#"</span> \
    | grep -v <span class="hljs-string">"^ *$"</span> \
    | sed <span class="hljs-string">"/^\[/q"</span> \
    | sed <span class="hljs-string">"/^\[/d"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <h3 id="-hooks-name-host_cwd-"><code>hooks $name $host_cwd</code></h3>
<p>Executes all user-defined hooks of the specified name in the current environment.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">run_hooks</span></span>() {

  <span class="hljs-built_in">local</span> name=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$name</span>"</span> || abort hook name required</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>The command are run in the specified working directory on the host.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> dir=<span class="hljs-variable">$2</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span> || abort hook working directory required

  <span class="hljs-built_in">local</span> path=`get_last_config_value path`
  <span class="hljs-built_in">local</span> commands=`get_all_config_values <span class="hljs-variable">$name</span>`

  <span class="hljs-built_in">log</span> hook <span class="hljs-variable">$name</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Nothing is done if no hooks are defined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$commands</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"    nothing to do"</span>
    <span class="hljs-built_in">return</span> 0
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">local</span> old_ifs=<span class="hljs-variable">$IFS</span>
  IFS=$<span class="hljs-string">'\n'</span>

  <span class="hljs-keyword">for</span> cmd <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$commands</span>"</span>); <span class="hljs-keyword">do</span>
    IFS=<span class="hljs-string">"<span class="hljs-variable">$old_ifs</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Various environment variables are exported before executing each hook,
<code>$DEPLOY_PATH</code> indicating the deployment directory (not necessarily the same
as the hook working directory), and any additional user-defined variables.
See <code>build_export_env_command</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    run <span class="hljs-string">"cd <span class="hljs-variable">$dir</span> \
         &amp;&amp; <span class="hljs-variable">$(build_export_env_command)</span> \
         &amp;&amp; <span class="hljs-variable">$cmd</span> 2&gt;&amp;1"</span> \
      || abort <span class="hljs-variable">$name</span> hook failed

    IFS=$<span class="hljs-string">'\n'</span>
  <span class="hljs-keyword">done</span>

  IFS=<span class="hljs-string">"<span class="hljs-variable">$old_ifs</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <h3 id="-build_ssh_command-"><code>build_ssh_command</code></h3>
<p>Builds an SSH command to connect to the host.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">build_ssh_command</span></span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Various SSH options can be given through the config file or environment variables.
The <code>host</code> config (or <code>$DEPLOY_HOST</code> variable) is the only mandatory one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> host=$(get_last_config_value host)
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$host</span>"</span> || abort <span class="hljs-string">"no host config found in environment <span class="hljs-variable">$DEPLOY_ENV</span>"</span>

  <span class="hljs-built_in">local</span> url=<span class="hljs-variable">$host</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Specify the user to connect to the host as with the <code>user</code> config or the <code>$DEPLOY_USER</code> variable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> user=$(get_last_config_value user)
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$user</span>"</span> &amp;&amp; url=<span class="hljs-string">"<span class="hljs-variable">$user</span>@<span class="hljs-variable">$url</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Supply a private key (identity file) with the <code>key</code> config or the <code>$DEPLOY_KEY</code> variable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> key=<span class="hljs-string">"`get_last_config_value key`"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> &amp;&amp; key=<span class="hljs-string">"-i <span class="hljs-variable">$key</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Enable agent forwarding with the <code>forward-agent</code> config or the <code>$DEPLOY_FORWARD_AGENT</code> variable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> forward_agent=<span class="hljs-string">"`get_last_config_value forward-agent`"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$forward_agent</span>"</span> &amp;&amp; forward_agent=<span class="hljs-string">"-A"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Specify the host port to connect to with the <code>port</code> config or the <code>$DEPLOY_PORT</code> variable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> port=<span class="hljs-string">"`get_last_config_value port`"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$port</span>"</span> &amp;&amp; port=<span class="hljs-string">"-p <span class="hljs-variable">$port</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Force pseudo-terminal allocation with the <code>tty</code> key or the <code>$DEPLOY_TTY</code> variable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> tty=<span class="hljs-string">"`get_last_config_value tty`"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$tty</span>"</span> &amp;&amp; tty=<span class="hljs-string">"-t"</span>

  <span class="hljs-built_in">echo</span> <span class="hljs-string">"ssh <span class="hljs-variable">$tty</span> <span class="hljs-variable">$forward_agent</span> <span class="hljs-variable">$port</span> <span class="hljs-variable">$key</span> <span class="hljs-variable">$url</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <h3 id="-run-"><code>run $@</code></h3>
<p>Runs the specified command on the host through SSH.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">run</span></span>() {
  <span class="hljs-built_in">local</span> shell=<span class="hljs-string">"`build_ssh_command`"</span>
  echo_command <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
  <span class="hljs-variable">$shell</span> <span class="hljs-variable">$@</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <h3 id="-build_export_env_command-"><code>build_export_env_command</code></h3>
<p>Returns a command to run on the host to export environment variables for further command execution.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">build_export_env_command</span></span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>The <code>$DEPLOY_PATH</code> variable is always exported and indicates the deployment directory
configured by the user with the <code>path</code> config or the local <code>$DEPLOY_PATH</code> variable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> path=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_value path)</span>"</span>;
  <span class="hljs-built_in">local</span> env_command=<span class="hljs-string">"export DEPLOY_PATH=<span class="hljs-variable">$path</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Additional variables may be exported by the user with the <code>env</code> config in the form <code>env FOO=BAR</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  env_command=<span class="hljs-string">"<span class="hljs-variable">$command</span> <span class="hljs-variable">$(echo `get_all_config_values env`|sed 's/\n/ /g')</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Local variables may also be exported on the host with the <code>forward-env</code> config in the form <code>forward-env BAZ</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> forward_env <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">echo</span> `get_all_config_values forward-env`|sed <span class="hljs-string">'s/\n/ /g'</span>); <span class="hljs-keyword">do</span>
    env_command=<span class="hljs-string">"<span class="hljs-variable">$env_command</span> <span class="hljs-variable">$forward_env</span>=<span class="hljs-variable">$(echo "${!forward_env}"|sed 's/ /\\ /g')</span>"</span>
  <span class="hljs-keyword">done</span>

  <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$env_command</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <h3 id="-require_env-"><code>require_env</code></h3>
<p>Ensures that an environment has been selected by providing an argument before the command to run.
This is required for most (but not all) sub-commands. See <code>main</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">require_env</span></span>() {
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_ENV</span>"</span> || abort <span class="hljs-string">"&lt;env&gt; required"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>It also ensures that the config file contains a section for that environment.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  config_section_exists <span class="hljs-variable">$DEPLOY_ENV</span> || abort <span class="hljs-string">"[<span class="hljs-variable">$DEPLOY_ENV</span>] config section not defined"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <h3 id="-require_no_local_changes-"><code>require_no_local_changes</code></h3>
<p>Ensures that all changes are committed and pushed before deploying.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">require_no_local_changes</span></span>() {
  git --no-pager diff --<span class="hljs-built_in">exit</span>-code --quiet || abort <span class="hljs-string">"commit or stash your changes before deploying"</span>
  git --no-pager diff --<span class="hljs-built_in">exit</span>-code --quiet --cached || abort <span class="hljs-string">"commit your staged changes before deploying"</span>
  [ -z <span class="hljs-string">"`git rev-list @{upstream}.. -n 1`"</span> ] || abort <span class="hljs-string">"push your changes before deploying"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <h3 id="-command_exists-command-"><code>command_exists $command</code></h3>
<p>Checks whether the specified command exists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">command_exists</span></span>() {
  <span class="hljs-built_in">command</span> -v <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> &gt;/dev/null 2&gt;&amp;1
}</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <h3 id="-require_command-command-"><code>require_command $command</code></h3>
<p>Ensures that the specified command exists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">require_command</span></span>() {
  command_exists <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> || abort <span class="hljs-string">"<span class="hljs-variable">$1</span> command not found"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <h3 id="-check_requirements-"><code>check_requirements</code></h3>
<p>Ensures that all commands required for the execution of this script exist.
Some optional commands are not checked here. See <code>update_self</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">check_requirements</span></span>() {
  <span class="hljs-keyword">for</span> com <span class="hljs-keyword">in</span> cat cut date git grep ls mkdir sed ssh tail tar; <span class="hljs-keyword">do</span>
    require_command <span class="hljs-variable">$com</span>
  <span class="hljs-keyword">done</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <h3 id="-make_temporary_directory-"><code>make_temporary_directory</code></h3>
<p>Creates a temporary directory that will be cleaned up when this script exits.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">make_temporary_directory</span></span>() {
  DEPLOY_TMP_DIR=<span class="hljs-string">"<span class="hljs-variable">$(mktemp -d -t deploy)</span>"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_TMP_DIR</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <h3 id="-cleanup-dir-"><code>cleanup [$dir]</code></h3>
<p>Removes the specified directory if an argument is specified and it is an existing directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">cleanup</span></span>() {
  <span class="hljs-built_in">local</span> tmp_dir=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$tmp_dir</span>"</span> &amp;&amp; <span class="hljs-built_in">test</span> -d <span class="hljs-string">"<span class="hljs-variable">$tmp_dir</span>"</span> &amp;&amp; rm -fr <span class="hljs-string">"<span class="hljs-variable">$tmp_dir</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <h3 id="-abort-message-"><code>abort $message</code></h3>
<p>Aborts execution of this script with the specified message.
The script exists with status code 1.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">abort</span></span>() {
  <span class="hljs-built_in">echo</span>
  log_error <span class="hljs-string">"  <span class="hljs-variable">$@</span>"</span>
  <span class="hljs-built_in">echo</span>
  <span class="hljs-built_in">exit</span> 1
}</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <h3 id="-log-message-"><code>log $message</code></h3>
<p>Logs a deployment progress message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">log</span></span>() {
  <span class="hljs-built_in">echo</span>
  echo_color <span class="hljs-variable">$COLOR_BOLD</span> <span class="hljs-string">"  ○ <span class="hljs-variable">$@</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <h3 id="-log_command-message-"><code>log_command $message</code></h3>
<p>Logs a command that is being executed on the host.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">log_command</span></span>() {
  echo_color <span class="hljs-variable">$COLOR_YELLOW</span> <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span> | tr -s <span class="hljs-string">' '</span> | sed <span class="hljs-string">'s/^/    /'</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <h3 id="-log_error-message-"><code>log_error $message</code></h3>
<p>Logs an error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">log_error</span></span>() {
  echo_color <span class="hljs-variable">$COLOR_RED</span> <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span> 1&gt;&amp;2
}</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <h3 id="-echo_color-color-message-"><code>echo_color $color $message</code></h3>
<p>Prints a message in the specified color.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">echo_color</span></span>() {
  <span class="hljs-built_in">local</span> color=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">shift</span>
  <span class="hljs-built_in">local</span> message=<span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
  <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\033[<span class="hljs-variable">${color}</span>m<span class="hljs-variable">${message}</span>\033[0m"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <h2 id="main-command">Main command</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>COLOR_BOLD=1
COLOR_RED=31
COLOR_YELLOW=33</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Exit immediately if requirements are not met.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>check_requirements</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>If an <code>.env</code> file is present in the current directory, it is sourced before running any commands.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">test</span> -f .env &amp;&amp; { <span class="hljs-built_in">test</span> -r .env || abort <span class="hljs-string">"environment file .env is not readable"</span>; }
<span class="hljs-built_in">test</span> -f .env &amp;&amp; { . .env || abort <span class="hljs-string">"an error occurred while sourcing .env"</span>; }

DEPLOY_ENV=</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>The configuration file defaults to <code>./deploy.conf</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CONFIG</span>"</span> &amp;&amp; DEPLOY_CONFIG=./deploy.conf</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>The repo to update the script from defaults to <code>git://github.com/AlphaHydrae/deploy.git</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_UPDATE_REPO</span>"</span> &amp;&amp; DEPLOY_UPDATE_REPO=git://github.com/AlphaHydrae/deploy.git

<span class="hljs-keyword">while</span> <span class="hljs-built_in">test</span> <span class="hljs-variable">$#</span> -ne 0; <span class="hljs-keyword">do</span>
  arg=<span class="hljs-variable">$1</span>; <span class="hljs-built_in">shift</span>
  <span class="hljs-keyword">case</span> <span class="hljs-variable">$arg</span> <span class="hljs-keyword">in</span>
    -h|--<span class="hljs-built_in">help</span>) usage; <span class="hljs-built_in">exit</span> ;;
    -V|--version) version; <span class="hljs-built_in">exit</span> ;;
    -c|--config) set_config_path <span class="hljs-variable">$1</span>; <span class="hljs-built_in">shift</span> ;;
    -C|--<span class="hljs-built_in">chdir</span>) <span class="hljs-built_in">log</span> <span class="hljs-built_in">cd</span> <span class="hljs-variable">$1</span>; <span class="hljs-built_in">cd</span> <span class="hljs-variable">$1</span>; <span class="hljs-built_in">shift</span> ;;
    <span class="hljs-built_in">exec</span>) exec_remote_command <span class="hljs-variable">$@</span>; <span class="hljs-built_in">exit</span> ;;
    console) console <span class="hljs-variable">$1</span>; <span class="hljs-built_in">exit</span> ;;
    setup) setup <span class="hljs-variable">$@</span>; <span class="hljs-built_in">exit</span> ;;
    list) list_releases; <span class="hljs-built_in">exit</span> ;;
    ref) deploy_ref <span class="hljs-variable">$1</span>; <span class="hljs-built_in">exit</span> ;;
    update) update_self <span class="hljs-variable">$@</span>; <span class="hljs-built_in">exit</span> ;;
    config) config <span class="hljs-variable">$@</span>; <span class="hljs-built_in">exit</span> ;;
    config-all) config_all <span class="hljs-variable">$@</span>; <span class="hljs-built_in">exit</span> ;;
    *)
      <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_ENV</span>"</span>; <span class="hljs-keyword">then</span>
        DEPLOY_ENV=<span class="hljs-variable">$arg</span>;
      <span class="hljs-keyword">else</span>
        abort <span class="hljs-string">"unknown command or option <span class="hljs-variable">$arg</span>"</span>
      <span class="hljs-keyword">fi</span>
      ;;
  <span class="hljs-keyword">esac</span>
<span class="hljs-keyword">done</span>

usage
abort <span class="hljs-string">"no command given"</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script><script>
$(function() {
  $('ul.sections li').not('#title').filter(function() {
    return $(this).find('.annotation h2, .annotation h3').length;
  }).addClass('title');
});
</script></body>
</html>
