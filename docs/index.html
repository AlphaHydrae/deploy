<!DOCTYPE html>

<html>
<head>
  <title>deploy</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>deploy</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">#!/usr/bin/env bash

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><strong><em>A (magic) shell script to deploy Git repositories</em></strong></p>
<p><a href="https://travis-ci.org/AlphaHydrae/deploy"><img src="https://travis-ci.org/AlphaHydrae/deploy.svg?branch=master" alt="Build Status"></a>
<a href="https://badge.fury.io/js/bash-deploy"><img src="https://img.shields.io/badge/version-3.0.0-blue.svg" alt="npm version"></a>
<a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/npm/l/express.svg" alt="license"></a></p>
<p>Read the <a href="https://alphahydrae.github.io/deploy/">annotated source</a></p>
<p>Repository: <a href="https://github.com/AlphaHydrae/deploy">AlphaHydrae/deploy</a></p>
<p>Shamelessly inspired by: <a href="https://github.com/visionmedia/deploy">visionmedia/deploy</a></p>
<ul id="toc" style="display:none;"></ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>VERSION=3.0.0

COLORS=
COLOR_BOLD=1
COLOR_RED=31
COLOR_GREEN=32
COLOR_YELLOW=33
COLOR_MAGENTA=35
COLOR_CYAN=36

DEPLOY_ARGS=(<span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>)
DEPLOY_COMMAND=
DEPLOY_ENV=
DEPLOY_OPTIONS=()
DEPLOY_OPTIONS_MAP=<span class="hljs-string">''</span>

DEPLOY_COLOR=auto
DEPLOY_CONFIG=./deploy.conf
DEPLOY_UPDATE_PREFIX=/usr/<span class="hljs-built_in">local</span>
DEPLOY_UPDATE_REPO=https://github.com/AlphaHydrae/deploy.git
DEPLOY_UPDATE_REV=master

DEPLOY_SHORT_OPTIONS_MAP=$(cat &lt;&lt;-END
A:forward-agent
C:<span class="hljs-built_in">chdir</span>
c:config
f:force
h:<span class="hljs-built_in">help</span>
H:host
i:identity
k:keep
P:path
p:port
r:repo
t:tty
u:user
V:version
v:version
y:yes
END
)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="usage">Usage</h2>
<p><strong>deploy</strong> is a shell script to deploy your Git projects through SSH.
Add a <code>deploy.conf</code> file in your project’s directory.
Here’s an example for a Node.js project:</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[production]
repo  https://github.com/me/my-app
host  my.server.com
user  deploy
path  /var/www/app

<span class="hljs-comment"># describe how to deploy your app</span>
env          NODE_ENV=production
deploy       npm install --production
post-deploy  npm start
</code></pre><p><strong>deploy</strong> is language-agnostic.
For a Rails project, you could replace the last 3 lines with:</p>
<pre><code>env          RAILS_ENV=production
deploy       bundle install --without development <span class="hljs-built_in">test</span>
deploy       rake assets:precompile
post-deploy  rails server
</code></pre><p>Now run <strong>deploy</strong>!</p>
<pre><code class="lang-sh">deploy production setup
deploy production rev master
</code></pre>
<p>It will:</p>
<ul>
<li>Connect to <code>my.server.com</code> as the <code>deploy</code> user through SSH</li>
<li>The <code>setup</code> command will set up a deployment structure and clone your repository</li>
<li>The second <code>rev</code> command will checkout the latest version of your <code>master</code> branch and run the deployment hooks you defined (<code>deploy</code> and <code>post-deploy</code> in the configuration file)</li>
</ul>
<p>Read on to learn what to write in the <a href="#configuration-file">configuration file</a> or how to use each <a href="#sub-commands">sub-command</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">usage</span></span>() {
  cat &lt;&lt;-EOF

  Usage: deploy [options] [env] [<span class="hljs-built_in">command</span>]

  Default <span class="hljs-built_in">command</span>:
    &lt;env&gt; [options] [rev]   deploy a release (commit, branch or tag)
                            (same as the <span class="hljs-string">"rev"</span> <span class="hljs-built_in">command</span>)

  Deployment commands:

    &lt;env&gt; setup                 run host setup commands
    &lt;env&gt; rev [options] [rev]   deploy a release (commit, branch or tag)
    &lt;env&gt; console [path]        open an ssh session to the host
    &lt;env&gt; <span class="hljs-built_in">exec</span> &lt;cmd&gt;            execute the given <span class="hljs-built_in">command</span> on the host
    &lt;env&gt; list                  list deployed releases
    &lt;env&gt; cleanup [options]     clean up old releases

  Local commands:

    [env] config [key]       output whole config file or the value of one key
    &lt;env&gt; config-all &lt;key&gt;   output all values of a config key <span class="hljs-keyword">in</span> an environment
    [env] config-section     output a config section
    update [options] [rev]   update this script to the latest version

  General options:

    -C, --<span class="hljs-built_in">chdir</span> &lt;path&gt;    change the working directory
    --color &lt;mode&gt;        <span class="hljs-built_in">set</span> color mode to <span class="hljs-string">"always"</span>, <span class="hljs-string">"never"</span> or <span class="hljs-string">"auto"</span> (defaults to <span class="hljs-string">"auto"</span>)
    -c, --config &lt;path&gt;   <span class="hljs-built_in">set</span> config file path (defaults to ./deploy.conf)
    -y, --yes             accept all confirmation prompts (use with caution)
    -v, -V, --version     output current version
    -h, --<span class="hljs-built_in">help</span>            output usage information

  Deployment options:
    -P, --path &lt;dir&gt;   <span class="hljs-built_in">set</span> the remote path to deploy the project to on the host
    -r, --repo &lt;url&gt;   <span class="hljs-built_in">set</span> the Git URL to fetch <span class="hljs-built_in">source</span> code from when deploying

  SSH options:

    -A, --forward-agent     <span class="hljs-built_in">enable</span> SSH agent forwarding
    -H, --host &lt;address&gt;    <span class="hljs-built_in">set</span> the host to connect to
    -i, --identity &lt;file&gt;   select a file from <span class="hljs-built_in">which</span> the identity (private key)
                            <span class="hljs-keyword">for</span> public key authentication is <span class="hljs-built_in">read</span>
    -p, --port &lt;n&gt;          <span class="hljs-built_in">set</span> the port to connect to
    -t, --tty               force pseudo-terminal allocation
    -u, --user &lt;name&gt;       <span class="hljs-built_in">set</span> the host user to connect as

  Self-update options:

    --update-prefix &lt;dir&gt;   <span class="hljs-built_in">set</span> the base directory to update the deploy script
                            (full path will be &lt;dir&gt;/bin/deploy)
    --update-path &lt;file&gt;    <span class="hljs-built_in">set</span> the full path to the deploy script
                            (overrides --update-prefix)

  Examples:

    deploy prod setup             <span class="hljs-built_in">set</span> up the <span class="hljs-string">'prod'</span> host
    deploy prod master            deploy the <span class="hljs-string">'master'</span> branch <span class="hljs-keyword">in</span> the <span class="hljs-string">'prod'</span> env (shortcut)
    deploy prod rev master        (same)
    deploy dev foo                deploy the <span class="hljs-string">'foo'</span> branch <span class="hljs-keyword">in</span> the <span class="hljs-string">'dev'</span> env
    deploy prod <span class="hljs-built_in">exec</span> pm2 status   run <span class="hljs-string">'pm2 status'</span> <span class="hljs-keyword">in</span> the <span class="hljs-string">'prod'</span> env
    deploy dev config user        get the value of the <span class="hljs-string">'user'</span> key <span class="hljs-keyword">in</span> the <span class="hljs-string">'dev'</span> env
    deploy update                 update the deploy script
EOF
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="installation">Installation</h2>
<p>With npm:</p>
<pre><code class="lang-sh">npm install -g bash-deploy
</code></pre>
<p>With curl:</p>
<pre><code class="lang-sh">PREFIX=/usr/<span class="hljs-built_in">local</span>/bin \
  FROM=https://raw.githubusercontent.com \
  &amp;&amp; curl -sSLo <span class="hljs-variable">$PREFIX</span>/deploy \
  <span class="hljs-variable">$FROM</span>/AlphaHydrae/deploy/master/bin/deploy \
  &amp;&amp; chmod +x <span class="hljs-variable">$PREFIX</span>/deploy
</code></pre>
<p>With wget:</p>
<pre><code class="lang-sh">PREFIX=/usr/<span class="hljs-built_in">local</span>/bin \
  FROM=https://raw.githubusercontent.com \
  &amp;&amp; wget -qO <span class="hljs-variable">$PREFIX</span>/deploy \
  <span class="hljs-variable">$FROM</span>/AlphaHydrae/deploy/master/bin/deploy \
  &amp;&amp; chmod +x <span class="hljs-variable">$PREFIX</span>/deploy
</code></pre>
<p>Or <a href="https://raw.githubusercontent.com/AlphaHydrae/deploy/master/bin/deploy">download it</a> yourself.</p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="requirements">Requirements</h2>
<p><strong>deploy</strong> is a one-file bash script which requires the following commands: <code>cat</code>, <code>cut</code>, <code>date</code>, <code>git</code>, <code>grep</code>, <code>ls</code>, <code>mkdir</code>, <code>readlink</code>, <code>sed</code>, <code>ssh</code>, <code>tail</code>, <code>tar</code> and <code>wc</code>.
Most bash shells have all of those out of the box except perhaps <a href="https://git-scm.com">Git</a>.</p>
<p>It also optionally requires the <code>chmod</code>, <code>cp</code> and <code>mktemp</code> commands to update itself.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">check_requirements</span></span>() {
  <span class="hljs-keyword">for</span> com <span class="hljs-keyword">in</span> cat cut date git grep ls mkdir sed ssh tail tar wc; <span class="hljs-keyword">do</span>
    require_command <span class="hljs-variable">$com</span>
  <span class="hljs-keyword">done</span>
}

<span class="hljs-function"><span class="hljs-title">require_command</span></span>() {
  command_exists <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> || abort <span class="hljs-string">"<span class="hljs-variable">$1</span> command not found"</span>
}

<span class="hljs-function"><span class="hljs-title">command_exists</span></span>() {
  <span class="hljs-built_in">command</span> -v <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> &gt;/dev/null 2&gt;&amp;1
}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="configuration-file">Configuration file</h2>
<p><strong>deploy</strong> reads its main configuration from a <code>deploy.conf</code> file in the current directory.
It can also be customized with <a href="#command-line-options">environment variables and command line options</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">config_file_exists</span></span>() {
  <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CONFIG</span>"</span> &amp;&amp; <span class="hljs-built_in">test</span> -r <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CONFIG</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The configuration file is basically a series of sections containing key/value pairs:</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[staging]
host  staging.example.com
user  <span class="hljs-built_in">test</span>
<span class="hljs-comment"># how to deploy</span>
post-deploy  ./run-test.sh

[production]
host 192.168.1.42
user root
<span class="hljs-comment"># how to deploy</span>
env           NODE_ENV=production
deploy        npm install --production
deploy        npm run build
post-deploy   pm2 start pm2.json
</code></pre><p>Each named section, delimited by <code>[name]</code>, represents an <strong>environment</strong> (i.e. a host machine) to deploy to,
in this example the <em>staging</em> and <em>production</em> environments.</p>
<p>Lines beginning with <code>#</code> are comments and are ignored.</p>
<p>Other lines are key/value pairs.
A key is a sequence of characters containing no whitespace, followed by at least one tab or space.</p>
<p>For example, in the line <code>deploy npm run build</code>, the key is <code>deploy</code> and its value is <code>npm run build</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">config_section_exists</span></span>() {
  grep <span class="hljs-string">"^\[<span class="hljs-variable">$1</span>\]$"</span> <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CONFIG</span>"</span> &amp;&gt; /dev/null
}

<span class="hljs-function"><span class="hljs-title">get_config_section</span></span>() {
  <span class="hljs-built_in">local</span> env=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>

  grep <span class="hljs-string">"^\[<span class="hljs-variable">$env</span>\]$"</span> -A 999 <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CONFIG</span>"</span> \
    | tail -n +2 \
    | grep -v <span class="hljs-string">"^ *#"</span> \
    | grep -v <span class="hljs-string">"^ *$"</span> \
    | sed <span class="hljs-string">"/^\[/q"</span> \
    | sed <span class="hljs-string">"/^\[/d"</span>
}

<span class="hljs-function"><span class="hljs-title">get_config_key_values_in_env</span></span>() {

  <span class="hljs-built_in">local</span> key=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">local</span> env=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>

  get_config_section <span class="hljs-variable">$env</span> \
    | grep <span class="hljs-string">"^<span class="hljs-variable">$key</span>[ \t][ \t]*[^ \t]"</span> \
    | cut -d <span class="hljs-string">' '</span> -f 2-999 \
    | sed <span class="hljs-string">"s/^ *//"</span> \
    | sed <span class="hljs-string">"s/ *$//"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3 id="single-value-and-multiple-value-keys">Single-value and multiple-value keys</h3>
<p>Some keys like <code>repo</code>, <code>host</code>, <code>port</code> or <code>user</code> are simple configuration properties that have one value per environment.
If multiple values are found, the last one is used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_last_config_key_value</span></span>() {

  <span class="hljs-built_in">local</span> key=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">local</span> env_var=$(get_config_key_env_var <span class="hljs-variable">$key</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>These keys can be overriden through an environment variable of the same name in uppercase and prefixed by <code>DEPLOY_</code>.
For example, the environment variable to override the <code>repo</code> key is <code>DEPLOY_REPO</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> env_var_value=<span class="hljs-variable">${!env_var}</span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$env_var_value</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$env_var_value</span>"</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> \
      &amp;&amp; get_all_config_key_values <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> \
      | tail -n 1
  <span class="hljs-keyword">fi</span>
}

<span class="hljs-function"><span class="hljs-title">get_config_key_env_var</span></span>() {
  <span class="hljs-built_in">local</span> key=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"DEPLOY_<span class="hljs-variable">$key</span>"</span> | tr <span class="hljs-string">'-'</span> <span class="hljs-string">'_'</span> | tr <span class="hljs-string">'[a-z]'</span> <span class="hljs-string">'[A-Z]'</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Other keys like <code>setup</code>, <code>deploy</code> or <code>post-deploy</code> are multiple-value keys used for <a href="#hooks">hooks</a>.
They can be present multiple time in the same environment and all their values will be used in order.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_all_config_key_values</span></span>() {

  <span class="hljs-built_in">local</span> env=<span class="hljs-variable">$DEPLOY_ENV</span>
  <span class="hljs-built_in">local</span> key=<span class="hljs-variable">$1</span>

  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$env</span>"</span> \
    &amp;&amp; <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> \
    &amp;&amp; get_config_key_values_inherited <span class="hljs-variable">$key</span> <span class="hljs-variable">$env</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h3 id="environment-inheritance">Environment inheritance</h3>
<p>When deploying your project to multiple environments, there will probably be some configuration properties
that are identical for multiple environments.
To avoid repetition, an environment can <strong>inherit</strong> from one or multiple other environments:</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[common]
user dev
deploy <span class="hljs-keyword">do</span>-stuff
deploy <span class="hljs-keyword">do</span>-more-stuff

[secure]
user sekret
deploy <span class="hljs-keyword">do</span>-sensitive-stuff

[production]
inherits common
inherits secure
user root
deploy just-do-it
</code></pre><p>In this example, the <code>production</code> environment inherits from <code>common</code> and <code>secure</code> (in that order).</p>
<p>The value of a <em>single-value</em> key like <code>user</code> will be the last value found in the environment inheritance tree.
In this case, it will be <code>root</code> for the <code>production</code> environment (the values inherited from the <code>common</code> and <code>secure</code> environments are overwritten).</p>
<p>A <em>multiple-value</em> key like <code>deploy</code> will include all values found in the entire inheritance tree.
In this case, it will have 4 values for the <code>production</code> environments, taken in order from the <code>common</code>, <code>secure</code> and <code>production</code> sections:</p>
<pre><code><span class="hljs-keyword">do</span>-stuff
<span class="hljs-keyword">do</span>-more-stuff
<span class="hljs-keyword">do</span>-sensitive-stuff
just-do-it
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_config_key_values_inherited</span></span>() {

  <span class="hljs-built_in">local</span> key=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">local</span> env=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
  <span class="hljs-built_in">local</span> values=

  <span class="hljs-keyword">if</span> ! config_section_exists <span class="hljs-variable">$env</span>; <span class="hljs-keyword">then</span>
    abort <span class="hljs-string">"[<span class="hljs-variable">$env</span>] config section not defined"</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">local</span> new_line=$<span class="hljs-string">'\n'</span>
  <span class="hljs-built_in">local</span> old_ifs=<span class="hljs-variable">$IFS</span>
  IFS=$<span class="hljs-string">'\n'</span>

  <span class="hljs-built_in">local</span> inherits=<span class="hljs-string">"<span class="hljs-variable">$(get_config_key_values_in_env inherits $env)</span>"</span>
  <span class="hljs-keyword">for</span> inherits_key <span class="hljs-keyword">in</span> <span class="hljs-variable">$inherits</span>; <span class="hljs-keyword">do</span>
    IFS=<span class="hljs-string">"<span class="hljs-variable">$old_ifs</span>"</span>

    <span class="hljs-built_in">local</span> inherited_values=<span class="hljs-string">"<span class="hljs-variable">$(get_config_key_values_inherited $key $inherits_key)</span>"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$inherited_values</span>"</span>; <span class="hljs-keyword">then</span>
      <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$values</span>"</span> &amp;&amp; values=<span class="hljs-string">"<span class="hljs-variable">$values</span><span class="hljs-variable">$new_line</span>"</span>
      values=<span class="hljs-string">"<span class="hljs-variable">$values</span><span class="hljs-variable">$inherited_values</span>"</span>
    <span class="hljs-keyword">fi</span>

    IFS=$<span class="hljs-string">'\n'</span>
  <span class="hljs-keyword">done</span>

  IFS=<span class="hljs-string">"<span class="hljs-variable">$old_ifs</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>For convenience in simple use cases, you can also add a <strong>default environment</strong> by including a nameless section in your configuration file:</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
[]
user dev
deploy <span class="hljs-keyword">do</span>-stuff
deploy <span class="hljs-keyword">do</span>-more-stuff

[development]
deploy <span class="hljs-keyword">do</span>-it-somehow

[production]
user root
deploy <span class="hljs-keyword">do</span>-it-seriously
</code></pre><p>All environments that have no <code>inherits</code> key automatically inherit from the default environment.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$inherits</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">local</span> default_environment_values=<span class="hljs-string">"<span class="hljs-variable">$(get_config_key_values_in_env $key)</span>"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$default_environment_values</span>"</span>; <span class="hljs-keyword">then</span>
      [ -n <span class="hljs-string">"<span class="hljs-variable">$values</span>"</span> ] &amp;&amp; values=<span class="hljs-string">"<span class="hljs-variable">$new_line</span><span class="hljs-variable">$values</span>"</span>
      values=<span class="hljs-string">"<span class="hljs-variable">$default_environment_values</span><span class="hljs-variable">$values</span>"</span>
    <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">local</span> current_environment_values=<span class="hljs-string">"<span class="hljs-variable">$(get_config_key_values_in_env $key $env)</span>"</span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$current_environment_values</span>"</span>; <span class="hljs-keyword">then</span>
    [ -n <span class="hljs-string">"<span class="hljs-variable">$values</span>"</span> ] &amp;&amp; values=<span class="hljs-string">"<span class="hljs-variable">$values</span><span class="hljs-variable">$new_line</span>"</span>
    values=<span class="hljs-string">"<span class="hljs-variable">$values</span><span class="hljs-variable">$current_environment_values</span>"</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$values</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h2 id="hooks">Hooks</h2>
<p>Hooks are user-defined commands that can be run during a <em>deployment phase</em>.
There are currently two phases defined: <strong>setup</strong> and <strong>deploy</strong>.
The <em>setup</em> phase happens when you run the <code>setup</code> command,
while the <em>deploy</em> phase happens when you run the <code>rev</code> command.</p>
<p>There are various hooks for each phase: some that run before, some during and some after <strong>deploy</strong> does its thing.
These are the currently available hooks:</p>
<pre><code>pre-setup
post-setup

pre-deploy
deploy
post-deploy
</code></pre><p>Hooks are multiple-value keys that are optional and can be used as many times as you want.
They will all be run in order.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">run_hooks</span></span>() {

  <span class="hljs-built_in">local</span> name=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$name</span>"</span> || abort hook name required
  <span class="hljs-built_in">local</span> dir=<span class="hljs-variable">$2</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span> || abort hook working directory required

  <span class="hljs-built_in">local</span> path=`get_last_config_key_value path`
  <span class="hljs-built_in">local</span> commands=`get_all_config_key_values <span class="hljs-variable">$name</span>`

  <span class="hljs-built_in">log</span> hook <span class="hljs-variable">$name</span>

  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$commands</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"    nothing to do"</span>
    <span class="hljs-built_in">return</span> 0
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">local</span> old_ifs=<span class="hljs-variable">$IFS</span>
  IFS=$<span class="hljs-string">'\n'</span>

  <span class="hljs-keyword">for</span> cmd <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$commands</span>"</span>); <span class="hljs-keyword">do</span>
    IFS=<span class="hljs-string">"<span class="hljs-variable">$old_ifs</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Each hook is run in a specific working directory and has access to various environment variables.
<code>$DEPLOY_PATH</code> is always exported and indicates the deployment directory
(which is not necessarily the same as the hook’s working directory).
Additional user-defined variables may also be made available (see <a href="#host-environment-variables">environment variables</a>).</p>
<p>Here’s an example of how you could use hooks to cache your <code>node_modules</code> directory after every deployment
to shorten future installation times:</p>
<pre><code><span class="hljs-comment"># restore cache (if present)</span>
deploy       tar -xzf <span class="hljs-variable">$DEPLOY_PATH</span>/cache.gz -C . || <span class="hljs-built_in">exit</span> 0
<span class="hljs-comment"># install new dependencies</span>
deploy       npm install --production
<span class="hljs-comment"># update cache</span>
post-deploy  tar -czf <span class="hljs-variable">$DEPLOY_PATH</span>/cache.gz node_modules
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    run <span class="hljs-string">"cd <span class="hljs-variable">$dir</span> \
         &amp;&amp; <span class="hljs-variable">$(build_export_env_command)</span> \
         &amp;&amp; <span class="hljs-variable">$cmd</span> 2&gt;&amp;1"</span> \
      || abort <span class="hljs-variable">$name</span> hook failed

    IFS=$<span class="hljs-string">'\n'</span>
  <span class="hljs-keyword">done</span>

  IFS=<span class="hljs-string">"<span class="hljs-variable">$old_ifs</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>See the <a href="#setup"><code>setup</code></a> and <a href="#deploy"><code>rev</code></a> commands to learn exactly when and where hooks are executed.</p>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h2 id="configuration-file">Configuration file</h2>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h3 id="project">Project</h3>
<ul>
<li><strong><code>repo &lt;url&gt;</code></strong> (or the <code>$DEPLOY_REPO</code> variable) defines the Git URL from which your repository will be cloned at setup time.</li>
<li><strong><code>path &lt;dir&gt;</code></strong> (or the <code>$DEPLOY_PATH</code> variable) defines the directory into which your project will be deployed on the host.</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <ul>
<li><p><a name="keep"></a>
<strong><code>keep &lt;n&gt;</code></strong> (or the <code>$DEPLOY_KEEP</code> variable) defines how many releases to keep after deploying.
Older releases will be deleted. It must be either <code>all</code> (the default), or an integer greater than zero.</p>
<p>If it’s a number, it indicates the number of releases that should be kept <strong>after successful deployment</strong>.
For example, with <code>keep</code> set to 3, if there are 5 old releases deployed before running the script, 3 will be deleted
(so that 2 old releases and the new one being deployed, 3 in total, remain).</p>
<p>It’s also possible to manually trigger cleanup with the <a href="#cleanup">cleanup</a> command.</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">validate_keep</span></span>() {
  <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_KEEP</span>"</span> || [[ <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_KEEP</span>"</span> == <span class="hljs-string">"all"</span> ]] || [[ <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_KEEP</span>"</span> =~ ^[1-9][0-9]*$ ]] || abort <span class="hljs-string">"keep must be \"all\" or a positive integer greater than zero"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h3 id="ssh-connection">SSH connection</h3>
<p>Various SSH options can be specified through the configuration file or environment variables:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">build_ssh_command</span></span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <ul>
<li><strong><code>host &lt;address&gt;</code></strong> (or the <code>$DEPLOY_HOST</code> variable) is mandatory for all environments.
It indicates which host or IP address to connect to.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> host=$(get_last_config_key_value host)
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$host</span>"</span> || abort <span class="hljs-string">"host not configured"</span>

  <span class="hljs-built_in">local</span> url=<span class="hljs-variable">$host</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <ul>
<li><strong><code>user &lt;name&gt;</code></strong> (or the <code>$DEPLOY_USER</code> variable) specifies the user to connect as.
By default, you connect with the same name as your local user.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> user=$(get_last_config_key_value user)
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$user</span>"</span> &amp;&amp; url=<span class="hljs-string">"<span class="hljs-variable">$user</span>@<span class="hljs-variable">$url</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <ul>
<li><strong><code>identity &lt;file&gt;</code></strong> (or the <code>$DEPLOY_IDENTITY</code> variable) specifies a file from which the private key for public key authentication is read.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> identity=<span class="hljs-string">"`get_last_config_key_value identity`"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$identity</span>"</span> &amp;&amp; identity=<span class="hljs-string">"-i <span class="hljs-variable">$identity</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <ul>
<li><strong><code>forward-agent yes</code></strong> (or the <code>$DEPLOY_FORWARD_AGENT</code> variable) enables agent forwarding.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> forward_agent=<span class="hljs-string">"`get_last_config_key_value forward-agent`"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$forward_agent</span>"</span> &amp;&amp; forward_agent=<span class="hljs-string">"-A"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <ul>
<li><strong><code>port &lt;number&gt;</code></strong> (or the <code>$DEPLOY_PORT</code> variable) specifies the host port to connect to.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> port=<span class="hljs-string">"`get_last_config_key_value port`"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$port</span>"</span> &amp;&amp; port=<span class="hljs-string">"-p <span class="hljs-variable">$port</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <ul>
<li><strong><code>tty yes</code></strong> (or the <code>$DEPLOY_TTY</code> variable) forces pseudo-terminal allocation.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> tty=<span class="hljs-string">"`get_last_config_key_value tty`"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$tty</span>"</span> &amp;&amp; tty=<span class="hljs-string">"-t"</span>

  <span class="hljs-built_in">echo</span> <span class="hljs-string">"ssh <span class="hljs-variable">$tty</span> <span class="hljs-variable">$forward_agent</span> <span class="hljs-variable">$port</span> <span class="hljs-variable">$identity</span> <span class="hljs-variable">$url</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Commands executed on the host through SSH will be logged to the console.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">run</span></span>() {
  log_command <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
  run_no_log <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>For some commands, the output may be retrieved and displayed in a more user-friendly manner.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">run_no_log</span></span>() {
  <span class="hljs-built_in">local</span> shell
  shell=<span class="hljs-string">"<span class="hljs-variable">$(build_ssh_command 2&gt;&amp;1)</span>"</span>
  <span class="hljs-built_in">test</span> $? -eq 0 || abort <span class="hljs-string">"<span class="hljs-variable">$shell</span>"</span>
  <span class="hljs-variable">$shell</span> <span class="hljs-variable">$@</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h3 id="host-environment-variables">Host environment variables</h3>
<p>You can define environment variables that will be exported on the host when executing hooks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">build_export_env_command</span></span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>The <code>$DEPLOY_PATH</code> variable is always exported and indicates the deployment directory
configured by the user with the <code>path</code> config key or the local <code>$DEPLOY_PATH</code> variable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> path=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_key_value path)</span>"</span>;
  <span class="hljs-built_in">local</span> env_command=<span class="hljs-string">"export DEPLOY_PATH=<span class="hljs-variable">$path</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <ul>
<li><p><strong><code>env &lt;NAME&gt;=&lt;VALUE&gt;...</code></strong> defines one or multiple environment variables to export on the host when running hooks.</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
env FOO=BAR
env BAZ=QUX CORGE=GRAULT
</code></pre></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  env_command=<span class="hljs-string">"<span class="hljs-variable">$env_command</span> <span class="hljs-variable">$(echo `get_all_config_key_values env`|sed 's/\n/ /g')</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <ul>
<li><p><strong><code>forward-env &lt;NAME&gt;...</code></strong> defines the name(s) of one or multiple local environment variables
to export on the host when running hooks.</p>
<pre><code><span class="hljs-comment"># deploy.conf</span>
forward-env FOO
forward-env BAR BAZ QUX
</code></pre></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> forward_env <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">echo</span> `get_all_config_key_values forward-env`|sed <span class="hljs-string">'s/\n/ /g'</span>); <span class="hljs-keyword">do</span>
    env_command=<span class="hljs-string">"<span class="hljs-variable">$env_command</span> <span class="hljs-variable">$forward_env</span>=<span class="hljs-variable">$(echo "${!forward_env}"|sed 's/ /\\ /g')</span>"</span>
  <span class="hljs-keyword">done</span>

  <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$env_command</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>If you have a <code>.env</code> file in your local project directory, it will automatically be sourced.
This can be handy to create local variables that you can forward to the host.</p>
<pre><code><span class="hljs-comment"># .env</span>
<span class="hljs-built_in">export</span> FOO=BAR
<span class="hljs-built_in">export</span> YEAR=$(date <span class="hljs-string">"+%Y"</span>)
</code></pre><p>(Note that if you use the <code>-C, --chdir</code> command line option or the <code>$DEPLOY_CHDIR</code> variable,
the <code>.env</code> file is read <em>after</em> the working directory is set, so setting <code>$DEPLOY_CHDIR</code>
in the file has no effect.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">load_env_file</span></span>() {
  <span class="hljs-built_in">test</span> -f .env &amp;&amp; { <span class="hljs-built_in">test</span> -r .env || abort <span class="hljs-string">"environment file .env is not readable"</span>; }
  <span class="hljs-built_in">test</span> -f .env &amp;&amp; { . .env || abort <span class="hljs-string">"an error occurred while sourcing .env"</span>; }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h2 id="command-line-options-environment-variables">Command line options &amp; environment variables</h2>
<p>The properties in the configuration file can also be specified through <em>command line options</em> or <em>environment variables</em>.</p>
<p>For example, the <code>repo</code> property in the configuration file can also be specified:</p>
<ul>
<li>With the <code>-r, --repo &lt;url&gt;</code> command line option.</li>
<li>With the <code>$DEPLOY_REPO</code> environment variable.</li>
</ul>
<p>Their precedence is as follows:</p>
<ul>
<li>The command line option (e.g. <code>-r, --repo &lt;url&gt;</code>) always takes precedence if specified.</li>
<li>Next, the environment variable (e.g. <code>$DEPLOY_REPO</code>) takes precedence over the configuration file.</li>
<li>Otherwise, the value in the configuration file (e.g. <code>repo</code>) is used.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">parse_script_options</span></span>() {

  <span class="hljs-built_in">local</span> i=0

  <span class="hljs-keyword">while</span> <span class="hljs-built_in">test</span> <span class="hljs-variable">$i</span> -lt <span class="hljs-string">"<span class="hljs-variable">$(script_arg_count)</span>"</span>; <span class="hljs-keyword">do</span>

    <span class="hljs-built_in">local</span> option=<span class="hljs-string">"<span class="hljs-variable">$(script_arg $i)</span>"</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$option</span>"</span> != -* ]]; <span class="hljs-keyword">then</span>
      ((i++))
      <span class="hljs-built_in">continue</span>
    <span class="hljs-keyword">fi</span>

    <span class="hljs-built_in">local</span> value=<span class="hljs-string">"<span class="hljs-variable">$(script_arg $((i+1)</span>))"</span>
    <span class="hljs-built_in">local</span> has_value=

    <span class="hljs-keyword">case</span> <span class="hljs-variable">$option</span> <span class="hljs-keyword">in</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h3 id="general-options">General options</h3>
<p>These options are valid for most sub-commands:</p>

            </div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <ul>
<li><strong><code>-C, --chdir &lt;dir&gt;</code></strong> (or the <code>$DEPLOY_CHDIR</code> variable) changes <strong>deploy</strong>‘s <em>local</em> working directory before loading the configuration file.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      -C|--<span class="hljs-built_in">chdir</span>) has_value=1 ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <ul>
<li><p><strong><code>--color always|never|auto</code></strong> (or the <code>$DEPLOY_COLOR</code> variable) enables/disables colors in the output of the script.</p>
<p>This defaults to <code>auto</code>, which only enables colors if the current terminal is interactive.</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      --color) has_value=1 ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <ul>
<li><strong><code>-c, --config &lt;path&gt;</code></strong> (or the <code>$DEPLOY_CONFIG</code> variable) allows you to set a custom path for the configuration file (defaults to <code>./deploy.conf</code>).</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      -c|--config) has_value=1 ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <ul>
<li><strong><code>--help</code></strong> prints usage information and exits.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      -h|--<span class="hljs-built_in">help</span>) usage; <span class="hljs-built_in">echo</span>; <span class="hljs-built_in">exit</span> 0 ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <ul>
<li><strong><code>-v, -V, --version</code></strong> prints the current version and exits.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      -v|-V|--version) <span class="hljs-built_in">echo</span> <span class="hljs-variable">$VERSION</span>; <span class="hljs-built_in">exit</span> 0 ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <ul>
<li><p><strong><code>-y, --yes</code></strong> (or the <code>$DEPLOY_YES</code> variable) will automatically accept all confirmation prompts
(only valid for the <code>rev</code>, <code>cleanup</code> and <code>update</code> sub-commands).</p>
<p><strong>Use with caution:</strong> old releases may be deleted with the <code>rev</code> or <code>cleanup</code> sub-commands if a <a href="#keep"><code>keep</code> option</a> is configured.</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      -y|--yes) ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <h3 id="project-options">Project options</h3>
<p>These options configure where and how the project is deployed on the remote host:</p>

            </div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <ul>
<li><strong><code>-r, --repo &lt;url&gt;</code></strong> (or the <code>$DEPLOY_REPO</code> variable) sets the Git URL to fetch the project’s source code from when deploying.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      -r|--repo) has_value=1 ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <ul>
<li><strong><code>-P, --path &lt;dir&gt;</code></strong> sets the remote path to deploy the project to on the host
(this is the path to the directory managed by <strong>deploy</strong>, not to the current release).</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      -P|--path) has_value=1 ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <ul>
<li><strong><code>-k, --keep &lt;n&gt;</code></strong> (or the <code>$DEPLOY_KEEP</code> variable) changes the number of old releases that are kept
after successful deployment (see the <a href="#keep"><code>keep</code> option</a>).</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      -k|--keep) has_value=1 ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <ul>
<li><strong><code>-f, --force</code></strong> (or the <code>$DEPLOY_FORCE</code> variable) forces deployment to proceed even when you have uncommitted changes.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      -f|--force) ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h3 id="ssh-options">SSH options</h3>
<p>These options are valid for all commands which connect to the remote host through SSH
(<code>setup</code>, <code>rev</code>, <code>console</code>, <code>exec</code>, <code>list</code> and <code>cleanup</code>):</p>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <ul>
<li><p><strong><code>-A, --forward-agent</code></strong> (or the <code>$DEPLOY_FORWARD_AGENT</code> variable) enables forwarding of the authentication agent connection.</p>
<p><strong>Use with caution.</strong>
Users with the ability to bypass file permissions on the remote host (for the agent’s UNIX-domain socket)
can access the local agent through the forwarded connection.
An attacker cannot obtain key material from the agent,
however they can perform operations on the keys that enable them to authenticate
using the identities loaded into the agent.</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      -A|--forward-agent) ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <ul>
<li><strong><code>-H, --host &lt;address&gt;</code></strong> (or the <code>$DEPLOY_HOST</code> variable) sets the host to connect to.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      -H|--host) has_value=1 ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <ul>
<li><p><strong><code>-i, --identity &lt;file&gt;</code></strong> (or the <code>$DEPLOY_IDENTITY</code> variable) selects a file from which the identity (private key)
for public key authentication is read.</p>
<p>The default is <code>~/.ssh/id_dsa</code>, <code>~/.ssh/id_ecdsa</code>, <code>~/.ssh/id_ed25519</code> and <code>~/.ssh/id_rsa</code>.</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      -i|--identity) has_value=1 ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <ul>
<li><strong><code>-p, --port &lt;n&gt;</code></strong> (or the <code>$DEPLOY_PORT</code> variable) sets the port to connect to.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      -p|--port) has_value=1 ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <ul>
<li><p><strong><code>-t, --tty</code></strong> (or the <code>$DEPLOY_TTY</code> variable) forces pseudo-terminal allocation.</p>
<p>This can be used to execute arbitrary screen-based programs on a remote machine,
which can be very useful, e.g. when implementing menu services.</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      -t|--tty) ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <ul>
<li><strong><code>-u, --user &lt;name&gt;</code></strong> (or the <code>$DEPLOY_USER</code> variable) sets the remote user to connect as.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      -u|--user) has_value=1 ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <h3 id="self-update-options">Self-update options</h3>
<p>These options can be used by <strong>deploy</strong> to update itself with the <code>update</code> sub-command:</p>

            </div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <ul>
<li><p><strong><code>--update-path</code></strong> (or the <code>$DEPLOY_UPDATE_PATH</code> variable) sets the path to save the updated script when using the <strong>update</strong> command.</p>
<p>This overrides the <code>--update-prefix</code> or <code>$DEPLOY_UPDATE_PREFIX</code> options.</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      --update-path) has_value=1 ;;</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <ul>
<li><p><strong><code>--update-prefix</code></strong> (or the <code>$DEPLOY_UPDATE_PREFIX</code> variable) sets the base directory when using the <strong>update</strong> command.</p>
<p>The updated script will be saved in <code>bin/deploy</code> relative to this path.
(Note that setting <code>--update-path</code> or <code>$DEPLOY_UPDATE_PATH</code> overrides this option.)</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      --update-prefix) has_value=1 ;;

      *) usage; abort <span class="hljs-string">"unknown option '<span class="hljs-variable">$option</span>'"</span>
    <span class="hljs-keyword">esac</span>

    <span class="hljs-built_in">local</span> long_option=<span class="hljs-string">"<span class="hljs-variable">$(get_long_option "$option")</span>"</span>
    script_has_option <span class="hljs-string">"<span class="hljs-variable">$long_option</span>"</span> &amp;&amp; abort <span class="hljs-string">"option <span class="hljs-variable">$(describe_option "$long_option")</span> must only be given once"</span>

    DEPLOY_OPTIONS+=(<span class="hljs-string">"<span class="hljs-variable">$long_option</span>"</span>)

    <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$has_value</span>"</span> &amp;&amp; value=1
    DEPLOY_OPTIONS_MAP=<span class="hljs-string">"<span class="hljs-variable">$(printf "$DEPLOY_OPTIONS_MAP\n$long_option $value")</span>"</span>

    <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$has_value</span>"</span> &amp;&amp; script_remove_args <span class="hljs-variable">$i</span> || script_remove_args <span class="hljs-variable">$i</span> 2
  <span class="hljs-keyword">done</span>
}

<span class="hljs-function"><span class="hljs-title">apply_script_options</span></span>() {

  <span class="hljs-built_in">local</span> options=<span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
  <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$options</span>"</span> &amp;&amp; options=<span class="hljs-string">"<span class="hljs-variable">$(echo "$DEPLOY_OPTIONS_MAP"|cut -d ' ' -f 1|tr '\n' ' ')</span>"</span>

  <span class="hljs-keyword">for</span> option <span class="hljs-keyword">in</span> <span class="hljs-variable">$options</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">local</span> variable_name=<span class="hljs-string">"DEPLOY_<span class="hljs-variable">$(echo "$option"| tr '-' '_'|tr '[a-z]' '[A-Z]')</span>"</span>
    <span class="hljs-built_in">local</span> variable_value=<span class="hljs-string">"<span class="hljs-variable">$(echo "$DEPLOY_OPTIONS_MAP"|grep "^${option} "|cut -d ' ' -f 2-999)</span>"</span>
    <span class="hljs-built_in">export</span> <span class="hljs-variable">$variable_name</span>=<span class="hljs-string">"<span class="hljs-variable">$variable_value</span>"</span>
  <span class="hljs-keyword">done</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Note that command line options can be used anywhere in a <strong>deploy</strong> command.
The following 3 commands are equivalent:</p>
<ul>
<li><code>deploy -u deploy production --keep 3 --yes master</code></li>
<li><code>deploy -u deploy --keep 3 --yes production master</code></li>
<li><code>deploy production master -u deploy --keep 3 --yes</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">main</span></span>() {
  parse_script_options
  apply_script_options <span class="hljs-built_in">chdir</span>

  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CHDIR</span>"</span> &amp;&amp; change_working_directory <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CHDIR</span>"</span>
  load_env_file

  apply_script_options
  check_config_file_valid <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CONFIG</span>"</span>

  <span class="hljs-built_in">local</span> subcommand=
  <span class="hljs-keyword">while</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$subcommand</span>"</span>; <span class="hljs-keyword">do</span>
    DEPLOY_COMMAND=<span class="hljs-string">"<span class="hljs-variable">$(script_arg)</span>"</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_COMMAND</span>"</span> <span class="hljs-keyword">in</span>
      <span class="hljs-built_in">exec</span>) subcommand=exec_remote_command ;;
      cleanup) subcommand=clean_up_old_releases ;;
      console) subcommand=open_remote_console ;;
      setup) subcommand=set_up_host ;;
      list) subcommand=list_releases ;;
      rev) subcommand=deploy_rev ;;
      update) subcommand=update_self ;;
      config) subcommand=print_config_or_value ;;
      config-all) subcommand=print_config_values ;;
      config-section) subcommand=print_config_section ;;
      *)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_ENV</span>"</span>; <span class="hljs-keyword">then</span>
          DEPLOY_ENV=<span class="hljs-string">"<span class="hljs-variable">$DEPLOY_COMMAND</span>"</span>
        <span class="hljs-keyword">else</span>
          <span class="hljs-built_in">break</span>
        <span class="hljs-keyword">fi</span>
        ;;
    <span class="hljs-keyword">esac</span>
    script_shift
  <span class="hljs-keyword">done</span></pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <h2 id="default-command">Default command</h2>
<p><strong>deploy</strong> is usually used this way:</p>
<ul>
<li><code>deploy prod setup</code></li>
<li><code>deploy prod list</code></li>
<li><code>deploy prod rev master</code></li>
</ul>
<p>However, since the most often used sub-command is <code>rev</code>,
it is also the <strong>default command</strong>. The following 2 commands are equivalent:</p>
<ul>
<li><code>deploy prod master</code></li>
<li><code>deploy prod rev master</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$subcommand</span>"</span>; <span class="hljs-keyword">then</span>
    subcommand=deploy_rev
    DEPLOY_COMMAND=rev
  <span class="hljs-keyword">fi</span>

  <span class="hljs-variable">$subcommand</span>
}

<span class="hljs-function"><span class="hljs-title">change_working_directory</span></span>() {
  <span class="hljs-built_in">local</span> dir=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">test</span> -e <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span> || abort <span class="hljs-string">"invalid working directory: '<span class="hljs-variable">$dir</span>' does not exist"</span>
  <span class="hljs-built_in">test</span> -d <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span> || abort <span class="hljs-string">"invalid working directory: '<span class="hljs-variable">$dir</span>' is not a directory"</span>
  <span class="hljs-built_in">test</span> -x <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span> || abort <span class="hljs-string">"invalid working directory: '<span class="hljs-variable">$dir</span>' cannot be accessed"</span>
  <span class="hljs-built_in">cd</span> <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">check_config_file_valid</span></span>() {
  <span class="hljs-built_in">local</span> file=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">test</span> -e <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> || abort <span class="hljs-string">"invalid config file: <span class="hljs-variable">$file</span> does not exist"</span>
  <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> || abort <span class="hljs-string">"invalid config file: <span class="hljs-variable">$file</span> is not a file"</span>
  <span class="hljs-built_in">test</span> -r <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> || abort <span class="hljs-string">"invalid config file: <span class="hljs-variable">$file</span> cannot be read"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <h2 id="sub-commands">Sub-commands</h2>
<p>These are the commands you will use to set up and deploy your projects.</p>
<p>Note that most (but not all) of <strong>deploy</strong>‘s sub-commands require an environment to be specified before the actual command name, for example:</p>
<pre><code class="lang-sh">deploy setup             <span class="hljs-comment"># error! no environment</span>
deploy production setup  <span class="hljs-comment"># all good</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">require_env</span></span>() {
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_ENV</span>"</span> || abort <span class="hljs-string">"&lt;env&gt; required"</span>
  config_section_exists <span class="hljs-variable">$DEPLOY_ENV</span> || abort <span class="hljs-string">"[<span class="hljs-variable">$DEPLOY_ENV</span>] config section not defined"</span>
}

<span class="hljs-function"><span class="hljs-title">require_config</span></span>() {
  check_config_file_valid <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CONFIG</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">require_no_args</span></span>() {
  <span class="hljs-keyword">if</span> script_has_args; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">local</span> message=<span class="hljs-string">"<span class="hljs-variable">$(printf "command '$DEPLOY_COMMAND' takes no more arguments\n$(script_arg_count)</span> extra argument"</span>)<span class="hljs-string">"
    test <span class="hljs-variable">$(script_arg_count)</span> -ne 1 &amp;&amp; message="</span><span class="hljs-variable">${message}</span>s<span class="hljs-string">"
    abort "</span><span class="hljs-variable">$message</span> found: <span class="hljs-variable">${DEPLOY_ARGS[@]}</span><span class="hljs-string">"
  fi
}

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p><a name="setup"></a></p>

            </div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <h3 id="-env-setup-"><code>&lt;env&gt; setup</code></h3>
<p>Perform <strong>first-time setup</strong> tasks on the host before deployment.
You should only have to run this once before deploying the first time.</p>
<pre><code class="lang-sh">deploy production setup
</code></pre>
<p><strong>deploy</strong> will create the following structure for you in the deployment directory defined by the <code>path</code> config key (or the <code>$DEPLOY_PATH</code> variable):</p>
<ul>
<li><code>$DEPLOY_PATH/releases</code> will contain each deployment’s files</li>
<li><code>$DEPLOY_PATH/repo</code> will be a bare clone of your Git repository</li>
<li><code>$DEPLOY_PATH/tmp</code> will be used to store temporary files during deployment</li>
</ul>
<p>This phase has 3 hooks that are all executed in the deployment directory.
Note that this directory <strong>must already exist</strong> on the host and be writable by the user you connect as.</p>
<p>This is what <strong>deploy</strong> will do during setup:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">set_up_host</span></span>() {
  require_env
  require_no_args
  whitelist_deploy_options repo

  <span class="hljs-built_in">local</span> host=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_key_value host)</span>"</span>
  <span class="hljs-built_in">local</span> path=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_key_value path)</span>"</span>
  <span class="hljs-built_in">local</span> repo=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_key_value repo)</span>"</span>

  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$host</span>"</span> || abort <span class="hljs-string">"host not configured"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> || abort <span class="hljs-string">"path not configured"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$repo</span>"</span> || abort <span class="hljs-string">"repo not configured"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <ul>
<li>Run user-defined <code>pre-setup</code> hooks (if any).</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run_hooks pre-setup <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <ul>
<li>Create the <code>releases</code> and a <code>tmp</code> directories if they don’t exist already.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> running setup
  run <span class="hljs-string">"{ test -d <span class="hljs-variable">$path</span> || exit 1; } &amp;&amp; mkdir -p <span class="hljs-variable">$path</span>/releases <span class="hljs-variable">$path</span>/tmp"</span> \
    || abort <span class="hljs-string">"failed to set up directories; make sure <span class="hljs-variable">$path</span> exists and is writable"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <ul>
<li>Clone the repository into the <code>repo</code> directory if it isn’t already there.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> cloning repo
  run <span class="hljs-string">"test -d <span class="hljs-variable">$path</span>/repo || { git clone --bare <span class="hljs-variable">$repo</span> <span class="hljs-variable">$path</span>/repo || exit 1; }"</span> \
    || abort <span class="hljs-string">"failed to clone repo"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <ul>
<li>Run user-defined <code>post-setup</code> hooks (if any).</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run_hooks post-setup <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span>

  <span class="hljs-built_in">echo</span>
  log_success <span class="hljs-string">"setup complete"</span>
  <span class="hljs-built_in">echo</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p><a name="deploy"></a></p>

            </div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <h3 id="-env-rev-rev-"><code>&lt;env&gt; rev [rev]</code></h3>
<p><strong>Deploy a new release</strong> from the latest changes in the Git repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">deploy_rev</span></span>() {
  require_env</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>You must provide a Git revision, i.e. a <strong>commit, branch or tag</strong> to deploy,
either as the <code>[rev]</code> argument, with the <code>rev</code> config key or the <code>$DEPLOY_REV</code> variable.</p>
<p>If your Git repository is <strong>private</strong>, make sure that the deployment user has access to it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> rev=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_key_value rev)</span>"</span>
  <span class="hljs-keyword">if</span> script_has_args; <span class="hljs-keyword">then</span>
    rev=<span class="hljs-string">"<span class="hljs-variable">$(script_arg)</span>"</span>
    script_shift
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$rev</span>"</span> || abort <span class="hljs-string">"no commit, branch or tag specified"</span>

  require_no_args
  whitelist_deploy_options force keep yes</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>For each deployment, a new release directory will be created in <code>releases</code> in the deployment directory.
The name of a release directory is the current date and time in the <code>YYYY-MM-DD-HH-MM-SS</code> format.
(You can list deployed releases with the <a href="#list">list command</a>.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> path=$(get_last_config_key_value path)
  <span class="hljs-built_in">local</span> release=$(date -u <span class="hljs-string">'+%Y-%m-%d-%H-%M-%S'</span>)
  <span class="hljs-built_in">local</span> current_dir=<span class="hljs-string">"<span class="hljs-variable">$path</span>/current"</span>
  <span class="hljs-built_in">local</span> release_dir=<span class="hljs-string">"<span class="hljs-variable">$path</span>/releases/<span class="hljs-variable">$release</span>"</span>
  <span class="hljs-built_in">local</span> tmp_dir=<span class="hljs-string">"<span class="hljs-variable">$path</span>/tmp"</span>
  <span class="hljs-built_in">local</span> keep=$(get_last_config_key_value keep)

  validate_keep</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Note that <strong>deploy</strong> will refuse to deploy unless all your local changes are committed and pushed.
You can override this behavior with the <code>-f|--force</code> option (or the <code>$DEPLOY_FORCE</code> variable).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  require_no_local_changes</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>This is what <strong>deploy</strong> will do during deployment:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> deploying
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"    revision: <span class="hljs-variable">$rev</span>"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"    release: <span class="hljs-variable">$release</span>"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"    keep: <span class="hljs-variable">${keep:-all}</span>"</span>

  <span class="hljs-built_in">log</span> checking current release

  <span class="hljs-built_in">local</span> get_current_release_dir_command=<span class="hljs-string">"readlink <span class="hljs-variable">$path</span>/current"</span>
  log_command <span class="hljs-string">"<span class="hljs-variable">$get_current_release_dir_command</span>"</span>

  <span class="hljs-built_in">local</span> current_release_dir=<span class="hljs-string">"<span class="hljs-variable">$(run_no_log "$get_current_release_dir_command")</span>"</span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$current_release_dir</span>"</span>; <span class="hljs-keyword">then</span>
    log_color <span class="hljs-variable">$COLOR_CYAN</span> <span class="hljs-string">"<span class="hljs-variable">$current_release_dir</span>"</span>
  <span class="hljs-keyword">else</span>
    log_color <span class="hljs-variable">$COLOR_CYAN</span> <span class="hljs-string">"none (pre-deploy hooks will not be run)"</span>
  <span class="hljs-keyword">fi</span></pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <ul>
<li>If a <a href="#keep"><code>keep</code> option</a> is configured, all previously deployed releases are listed,
with those to be deleted in red, and those to be kept and the current release in green, and
confirmation is asked that they may be deleted if the deployment is successful.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  prepare_to_delete_old_releases deploy</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <ul>
<li>User-defined pre-deploy hooks (if any) are run <strong>in the directory of the previous release</strong>.
You may define <strong>pre-deploy hooks</strong> to perform any task you might want to do before the actual deployment
(e.g. you might want to stop the currently running version or put it into maintenance mode).</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$current_release_dir</span>"</span>; <span class="hljs-keyword">then</span>
    run_hooks pre-deploy <span class="hljs-string">"<span class="hljs-variable">$current_release_dir</span>"</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">log</span> hook pre-deploy
    log_color <span class="hljs-variable">$COLOR_CYAN</span> <span class="hljs-string">"skipping because there is no current release"</span>
  <span class="hljs-keyword">fi</span></pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <ul>
<li>The latest changes are fetched from the repository.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> fetching updates
  run <span class="hljs-string">"cd <span class="hljs-variable">$path</span>/repo \
       &amp;&amp; git fetch origin '+refs/heads/*:refs/heads/*' \
       &amp;&amp; git rev-list -n 1 <span class="hljs-variable">$rev</span>"</span> \
    || abort <span class="hljs-string">"could not fetch changes"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <ul>
<li>The new release directory is created and the source is extracted at the specified revision into it.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> <span class="hljs-string">"extracting source at <span class="hljs-variable">$rev</span>"</span>
  run <span class="hljs-string">"cd <span class="hljs-variable">$path</span>/repo \
       &amp;&amp; mkdir -p <span class="hljs-variable">$release_dir</span> \
       &amp;&amp; git archive --output <span class="hljs-variable">$tmp_dir</span>/release-<span class="hljs-variable">$release</span>.tar <span class="hljs-variable">$rev</span> \
       &amp;&amp; tar -C <span class="hljs-variable">$release_dir</span> -x --file <span class="hljs-variable">$tmp_dir</span>/release-<span class="hljs-variable">$release</span>.tar \
       &amp;&amp; rm -f <span class="hljs-variable">$tmp_dir</span>/release-*.tar"</span> \
    || abort <span class="hljs-string">"could not extract source from repository"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <ul>
<li>User-defined deploy hooks (if any) are run in the new release directory.
You should define <strong>deploy hooks</strong> to build your application or install its dependencies at this stage.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run_hooks deploy <span class="hljs-variable">$release_dir</span></pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <ul>
<li>A symlink of the new release directory is created as <code>current</code> in the deployment directory.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> linking current
  run <span class="hljs-string">"ln -fns <span class="hljs-variable">$release_dir</span> <span class="hljs-variable">$current_dir</span>"</span> \
    || abort <span class="hljs-string">"could not create current symlink"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <ul>
<li><p>User-defined post-deploy hooks (if any) are run in the current release directory
(which is now the same as the new release directory that was just created).</p>
<p>You should define <strong>post-deploy hooks</strong> to execute or start your application at this stage.</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run_hooks post-deploy <span class="hljs-variable">$current_dir</span></pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <ul>
<li>Old releases are deleted according to the <code>keep</code> option (if configured and any were found).</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$releases_to_delete</span>"</span> &amp;&amp; delete_old_releases <span class="hljs-string">"<span class="hljs-variable">$releases_to_delete</span>"</span>

  <span class="hljs-built_in">echo</span>
  log_success successfully deployed
  <span class="hljs-built_in">echo</span>
}

<span class="hljs-function"><span class="hljs-title">require_no_local_changes</span></span>() {
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_FORCE</span>"</span>; <span class="hljs-keyword">then</span>
    git --no-pager diff --<span class="hljs-built_in">exit</span>-code --quiet || abort <span class="hljs-string">"commit or stash your changes before deploying"</span>
    git --no-pager diff --<span class="hljs-built_in">exit</span>-code --quiet --cached || abort <span class="hljs-string">"commit your staged changes before deploying"</span>
    [ -z <span class="hljs-string">"`git rev-list @{upstream}.. -n 1`"</span> ] || abort <span class="hljs-string">"push your changes before deploying"</span>
  <span class="hljs-keyword">fi</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <h3 id="-env-config-key-"><code>[env] config [key]</code></h3>
<p>Print values from your <code>deploy.conf</code> configuration file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">print_config_or_value</span></span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <ul>
<li><p>If called with <strong>no environment and no argument</strong>, it prints the whole configuration file:</p>
<pre><code class="lang-sh">$&gt; deploy config
[]
user dev

[production]
user root
port 222
</code></pre>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> ! script_has_args; <span class="hljs-keyword">then</span>
    whitelist_default_options
    <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_ENV</span>"</span> || abort <span class="hljs-string">"this commands only supports both [env] and [key] arguments or neither"</span>
    require_config
    cat <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_CONFIG</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <ul>
<li><p>If called with <strong>the environment and a key</strong>, it prints the last value of that key for that environment
(only the last value is printed even for a multiple-value key):</p>
<pre><code class="lang-sh">$&gt; deploy production config user
root
</code></pre>
<p>Exits with status 1 if no value is found for the key.</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span>

    <span class="hljs-built_in">local</span> key=<span class="hljs-string">"<span class="hljs-variable">$(script_arg)</span>"</span>
    script_shift
    require_env
    require_no_args
    whitelist_default_options

    <span class="hljs-built_in">local</span> value=$(get_last_config_key_value <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span>)
    <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$value</span>"</span> &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$value</span>"</span>
  <span class="hljs-keyword">fi</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <h3 id="-env-config-all-key-"><code>&lt;env&gt; config-all &lt;key&gt;</code></h3>
<p>Print all values of a config key in the current environment and its inherited environments
(all values are printed even for a single-value key):</p>
<pre><code class="lang-sh">$&gt; deploy production config-all user
dev
root
</code></pre>
<p>Exits with status 1 if no value is found for the key.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">print_config_values</span></span>() {
  require_env

  <span class="hljs-built_in">local</span> key=<span class="hljs-string">"<span class="hljs-variable">$(script_arg)</span>"</span>
  script_shift
  require_no_args
  whitelist_default_options

  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> || abort <span class="hljs-string">"&lt;key&gt; missing"</span>

  <span class="hljs-built_in">local</span> values=$(get_all_config_key_values <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span>)
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$values</span>"</span> &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$values</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <h3 id="-env-config-section-"><code>[env] config-section</code></h3>
<p>Print all values of a config section “as is” (with no inheritance).
If no environment is specified, the default config section is printed.</p>
<p>Exits with status 1 if the config section is not found (including the default one).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">print_config_section</span></span>() {
  require_no_args
  whitelist_default_options
  config_section_exists <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_ENV</span>"</span> &amp;&amp; get_config_section <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_ENV</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <h3 id="-env-console-path-"><code>&lt;env&gt; console [path]</code></h3>
<p>Launch an interactive <strong>ssh session</strong> on the host.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">open_remote_console</span></span>() {
  require_env</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <ul>
<li><p>If an <strong>absolute path</strong> is specified, the session starts there.</p>
<pre><code class="lang-sh">deploy production console /var/www
</code></pre>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> path=<span class="hljs-string">"<span class="hljs-variable">$(script_arg)</span>"</span>
  script_shift
  require_no_args
  whitelist_deploy_options</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <ul>
<li><p>If <strong>no path</strong> is specified, the session starts in the deployment directory.</p>
<pre><code class="lang-sh">deploy production console
</code></pre>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span>; <span class="hljs-keyword">then</span>
    path=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_key_value path)</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <ul>
<li><p>If a <strong>relative path</strong> is specified, it starts there relative to the deployment directory.</p>
<pre><code class="lang-sh">deploy production console current
</code></pre>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">elif</span> [[ ! <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> =~ ^\/ ]]; <span class="hljs-keyword">then</span>
    path=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_key_value path)</span>/<span class="hljs-variable">$path</span>"</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> || abort <span class="hljs-string">"path is required"</span>

  <span class="hljs-built_in">local</span> shell=<span class="hljs-string">"`build_ssh_command`"</span>
  log_command <span class="hljs-string">"<span class="hljs-variable">$shell</span> -t \"cd <span class="hljs-variable">$path</span>; \$SHELL -il\""</span>
  <span class="hljs-variable">$shell</span> -t <span class="hljs-string">"cd <span class="hljs-variable">$path</span>; \$SHELL -il"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p><a name="cleanup"></a></p>

            </div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <h3 id="-env-cleanup-"><code>&lt;env&gt; cleanup</code></h3>
<p>Deletes old releases based on the <a href="#keep"><code>keep</code> option</a>.</p>
<p>The number of releases to keep is determined from the <code>keep</code> configuration file option,
the <code>$DEPLOY_KEEP</code> variable or the <code>-k|--keep</code> command line option.</p>
<p>The releases to delete will be listed and confirmation will be asked before they are actually deleted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">clean_up_old_releases</span></span>() {
  require_env
  require_no_args
  whitelist_deploy_options keep yes

  <span class="hljs-built_in">local</span> keep=$(get_last_config_key_value keep)

  validate_keep

  <span class="hljs-built_in">log</span> cleaning up
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"    keep: <span class="hljs-variable">${keep:-all}</span>"</span>

  prepare_to_delete_old_releases cleanup

  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$releases_to_delete</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span>
    log_success <span class="hljs-string">"nothing to clean up"</span>
    <span class="hljs-built_in">echo</span>
  <span class="hljs-keyword">else</span>
    delete_old_releases
    <span class="hljs-built_in">echo</span>
  <span class="hljs-keyword">fi</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <h3 id="-env-exec-cmd-"><code>&lt;env&gt; exec &lt;cmd&gt;</code></h3>
<p><strong>Execute</strong> the specified command on the host.</p>
<pre><code class="lang-sh">deploy production <span class="hljs-built_in">exec</span> ps -ef
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">exec_remote_command</span></span>() {
  require_env
  whitelist_deploy_options
  <span class="hljs-built_in">local</span> path=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_key_value path)</span>"</span>
  run <span class="hljs-string">"cd <span class="hljs-variable">$path</span> &amp;&amp; <span class="hljs-variable">$(build_export_env_command)</span> &amp;&amp; <span class="hljs-variable">${DEPLOY_ARGS[@]}</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p><a name="list"></a></p>

            </div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <h3 id="-env-list-"><code>&lt;env&gt; list</code></h3>
<p>List the <strong>releases</strong> that have been deployed on the host.</p>
<pre><code class="lang-sh">$&gt; deploy production list
2016-12-24-17-45-23
2017-01-01-02-03-43
2017-04-01-00-00-00
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">list_releases</span></span>() {
  require_env
  require_no_args
  whitelist_deploy_options

  <span class="hljs-built_in">local</span> path=`get_last_config_key_value path`
  <span class="hljs-built_in">local</span> releases_path=<span class="hljs-string">"<span class="hljs-variable">$path</span>/releases"</span>

  <span class="hljs-built_in">log</span> <span class="hljs-string">"listing releases"</span>
  <span class="hljs-built_in">local</span> list_releases_command=<span class="hljs-string">"ls -1 '<span class="hljs-variable">$releases_path</span>'"</span>
  log_command <span class="hljs-string">"<span class="hljs-variable">$list_releases_command</span>"</span>

  <span class="hljs-built_in">local</span> releases_list
  releases_list=<span class="hljs-string">"<span class="hljs-variable">$(run_no_log "$list_releases_command")</span>"</span>
  <span class="hljs-built_in">test</span> $? -eq 0 || abort <span class="hljs-string">"could not list releases directory <span class="hljs-variable">$releases_path</span>; make sure it exists and is readable"</span>

  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$releases_list</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"No releases found"</span>
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">exit</span> 0
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">log</span> <span class="hljs-string">"checking current"</span>
  <span class="hljs-built_in">local</span> check_current_command=<span class="hljs-string">"readlink <span class="hljs-variable">$path</span>/current"</span>
  log_command <span class="hljs-string">"<span class="hljs-variable">$check_current_command</span>"</span>

  <span class="hljs-built_in">local</span> current_release_dir
  current_release_dir=<span class="hljs-string">"<span class="hljs-variable">$(run_no_log "$check_current_command")</span>"</span>

  <span class="hljs-built_in">echo</span>
  <span class="hljs-keyword">for</span> release <span class="hljs-keyword">in</span> <span class="hljs-variable">$releases_list</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$releases_path</span>/<span class="hljs-variable">$release</span>"</span> == <span class="hljs-string">"<span class="hljs-variable">$current_release_dir</span>"</span> ]]; <span class="hljs-keyword">then</span>
      log_color <span class="hljs-variable">$COLOR_GREEN</span> <span class="hljs-string">"<span class="hljs-variable">$releases_path</span>/<span class="hljs-variable">$release</span> (current)"</span>
    <span class="hljs-keyword">else</span>
      log_color <span class="hljs-variable">$COLOR_CYAN</span> <span class="hljs-string">"<span class="hljs-variable">$releases_path</span>/<span class="hljs-variable">$release</span>"</span>
    <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">done</span>

  <span class="hljs-built_in">echo</span>
  <span class="hljs-built_in">local</span> number_of_releases=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$releases_list</span>"</span>|wc -l)
  <span class="hljs-built_in">local</span> message=<span class="hljs-string">"<span class="hljs-variable">$number_of_releases</span> release"</span>
  <span class="hljs-built_in">test</span> <span class="hljs-variable">$number_of_releases</span> -ne 1 &amp;&amp; message=<span class="hljs-string">"<span class="hljs-variable">${message}</span>s"</span>
  log_success <span class="hljs-string">"<span class="hljs-variable">$message</span> found"</span>
  <span class="hljs-built_in">echo</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <h3 id="-update-rev-"><code>update [rev]</code></h3>
<p>Updates <strong>deploy</strong> to the latest version by downloading it from the Git repository and installing it at <code>/usr/local/bin/deploy</code> (by default).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">update_self</span></span>() {

  <span class="hljs-keyword">if</span> script_has_args; <span class="hljs-keyword">then</span>
    DEPLOY_UPDATE_REV=<span class="hljs-string">"<span class="hljs-variable">$(script_arg)</span>"</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_ENV</span>"</span> || abort <span class="hljs-string">"environment not supported for this command"</span>
  require_no_args
  whitelist_options color update-path update-prefix yes</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>In addition to the basic requirements, this sub-command also requires <code>chmod</code>, <code>cp</code> and <code>mktemp</code> to be available in the shell.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> com <span class="hljs-keyword">in</span> chmod cp mktemp; <span class="hljs-keyword">do</span>
    require_command <span class="hljs-variable">$com</span>
  <span class="hljs-keyword">done</span>

  <span class="hljs-built_in">local</span> rev=<span class="hljs-string">"<span class="hljs-variable">$DEPLOY_UPDATE_REV</span>"</span>
  <span class="hljs-built_in">local</span> path=<span class="hljs-string">"<span class="hljs-variable">$DEPLOY_UPDATE_PATH</span>"</span>
  <span class="hljs-built_in">local</span> repo=<span class="hljs-string">"<span class="hljs-variable">$DEPLOY_UPDATE_REPO</span>"</span>
  <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> &amp;&amp; path=<span class="hljs-string">"<span class="hljs-variable">$DEPLOY_UPDATE_PREFIX</span>/bin/deploy"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>The installation path must be a writable file or not exist.
If the installation path does not already exist, its parent must be a writable directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">test</span> -e <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> &amp;&amp; ! <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> &amp;&amp; abort <span class="hljs-string">"<span class="hljs-variable">$path</span> already exists and is not a file"</span>
  <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> &amp;&amp; ! <span class="hljs-built_in">test</span> -w <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> &amp;&amp; abort <span class="hljs-string">"<span class="hljs-variable">$path</span> is not writable"</span>

  <span class="hljs-built_in">local</span> dir=<span class="hljs-string">"<span class="hljs-variable">$(dirname "$path")</span>"</span>
  <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> || <span class="hljs-built_in">test</span> -e <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span> || abort <span class="hljs-string">"<span class="hljs-variable">$dir</span> does not exist"</span>
  <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> || <span class="hljs-built_in">test</span> -d <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span> || abort <span class="hljs-string">"<span class="hljs-variable">$dir</span> is not a directory"</span>
  <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$path</span>"</span> || <span class="hljs-built_in">test</span> -w <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span> || abort <span class="hljs-string">"<span class="hljs-variable">$dir</span> is not writable"</span>

  <span class="hljs-built_in">log</span> updating
  <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_UPDATE_PATH</span>"</span> &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"    prefix: <span class="hljs-variable">$DEPLOY_UPDATE_PREFIX</span>"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"    path: <span class="hljs-variable">$path</span>"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"    version: <span class="hljs-variable">$rev</span>"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"    repository: <span class="hljs-variable">$repo</span>"</span>

  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_YES</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span>

    <span class="hljs-built_in">local</span> update_confirmation=
    <span class="hljs-keyword">while</span> ! prompt_is_yes <span class="hljs-string">"<span class="hljs-variable">$update_confirmation</span>"</span> &amp;&amp; ! prompt_is_no <span class="hljs-string">"<span class="hljs-variable">$update_confirmation</span>"</span>; <span class="hljs-keyword">do</span>
      log_prompt <span class="hljs-string">"will update <span class="hljs-variable">$path</span>; please confirm (yes/no) "</span>
      <span class="hljs-built_in">read</span> update_confirmation
    <span class="hljs-keyword">done</span>

    <span class="hljs-keyword">if</span> prompt_is_no <span class="hljs-string">"<span class="hljs-variable">$update_confirmation</span>"</span>; <span class="hljs-keyword">then</span>
      abort <span class="hljs-string">"update interrupted"</span>
    <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">log</span> <span class="hljs-string">"cloning deploy from <span class="hljs-variable">$rev</span> @ <span class="hljs-variable">$repo</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>To perform the update, <strong>deploy</strong> will download its Git repository into a temporary directory that will be cleaned up when the update is done (or fails).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> tmp_dir=`mktemp -d -t deploy.XXX`
  <span class="hljs-built_in">trap</span> <span class="hljs-string">"local_cleanup <span class="hljs-variable">$tmp_dir</span>"</span> EXIT</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>The correct revision of the script is then copied to the installation path and made executable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">cd</span> <span class="hljs-string">"<span class="hljs-variable">$tmp_dir</span>"</span> \
    &amp;&amp; git <span class="hljs-built_in">clone</span> <span class="hljs-string">"<span class="hljs-variable">$repo</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$tmp_dir</span>"</span> || abort could not <span class="hljs-built_in">clone</span> <span class="hljs-string">"<span class="hljs-variable">$repo</span>"</span> \
    &amp;&amp; { \
      git rev-parse --verify <span class="hljs-variable">$rev</span> &amp;&gt;/dev/null &amp;&amp; git reset --hard <span class="hljs-variable">$rev</span> \
      || { git fetch origin <span class="hljs-variable">$rev</span> &amp;&amp; git reset --hard origin/<span class="hljs-variable">$rev</span>; }; \
    } || abort could not find <span class="hljs-variable">$rev</span> \
    &amp;&amp; cp bin/deploy <span class="hljs-variable">$path</span> \
    &amp;&amp; chmod +x <span class="hljs-variable">$path</span> \
    || abort could not update deploy

  <span class="hljs-built_in">echo</span>
  log_success <span class="hljs-string">"updated <span class="hljs-variable">$VERSION</span> -&gt; `./bin/deploy --version`"</span>
  <span class="hljs-built_in">echo</span>
}

<span class="hljs-function"><span class="hljs-title">local_cleanup</span></span>() {
  <span class="hljs-built_in">local</span> tmp_dir=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$tmp_dir</span>"</span> &amp;&amp; <span class="hljs-built_in">test</span> -d <span class="hljs-string">"<span class="hljs-variable">$tmp_dir</span>"</span> &amp;&amp; rm -fr <span class="hljs-string">"<span class="hljs-variable">$tmp_dir</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <h2 id="cleaning-up-old-releases">Cleaning up old releases</h2>
<p><strong>deploy</strong> creates a new release directory for each deployment.
By default, it keeps these directories forever, leaving you responsible for cleaning them up.</p>
<p>If given a <a href="#keep"><code>keep</code> option</a>, it can do it for you automatically after each deployment.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">prepare_to_delete_old_releases</span></span>() {

  <span class="hljs-built_in">local</span> <span class="hljs-built_in">command</span>=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>

  <span class="hljs-built_in">local</span> keep=<span class="hljs-string">"<span class="hljs-variable">$(get_last_config_key_value keep)</span>"</span>
  <span class="hljs-built_in">local</span> path=$(get_last_config_key_value path)
  <span class="hljs-built_in">local</span> release=$(date -u <span class="hljs-string">'+%Y-%m-%d-%H-%M-%S'</span>)
  releases_to_delete=

  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$keep</span>"</span> || [[ <span class="hljs-string">"<span class="hljs-variable">$keep</span>"</span> == <span class="hljs-string">"all"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">return</span> 0
  <span class="hljs-keyword">fi</span></pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p><strong>deploy</strong> will list the contents of the <code>releases</code> directory on the host.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">log</span> listing previous releases
  <span class="hljs-built_in">local</span> list_releases_command=<span class="hljs-string">"ls -1 <span class="hljs-variable">$path</span>/releases"</span>

  log_command <span class="hljs-string">"<span class="hljs-variable">$list_releases_command</span>"</span>
  <span class="hljs-built_in">local</span> releases_list
  releases_list=<span class="hljs-string">"<span class="hljs-variable">$(run_no_log "$list_releases_command 2&gt;&amp;1")</span>"</span>
  <span class="hljs-built_in">test</span> $? -eq 0 || abort <span class="hljs-string">"<span class="hljs-variable">$releases_list</span>"</span>

  <span class="hljs-built_in">local</span> number_of_releases=<span class="hljs-string">"<span class="hljs-variable">$(echo "$releases_list"|wc -l)</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>If no old release is found, deployment will proceed normally.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$releases_list</span>"</span>; <span class="hljs-keyword">then</span>
    log_color <span class="hljs-variable">$COLOR_CYAN</span> <span class="hljs-string">"no old releases to delete"</span>
    <span class="hljs-built_in">return</span> 0
  <span class="hljs-keyword">fi</span></pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>If the number of old releases is equal to or greater than the <code>keep</code> number,
<strong>deploy</strong> will print the list of releases that will be deleted in red.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">local</span> releases_to_keep=
  <span class="hljs-keyword">if</span> { [[ <span class="hljs-string">"<span class="hljs-variable">$command</span>"</span> == <span class="hljs-string">"deploy"</span> ]] &amp;&amp; <span class="hljs-built_in">test</span> <span class="hljs-string">"<span class="hljs-variable">$number_of_releases</span>"</span> -lt <span class="hljs-string">"<span class="hljs-variable">$keep</span>"</span>; } || { [[ <span class="hljs-string">"<span class="hljs-variable">$command</span>"</span> != <span class="hljs-string">"deploy"</span> ]] &amp;&amp; <span class="hljs-built_in">test</span> <span class="hljs-string">"<span class="hljs-variable">$number_of_releases</span>"</span> -le <span class="hljs-string">"<span class="hljs-variable">$keep</span>"</span>; }; <span class="hljs-keyword">then</span>
    releases_to_keep=<span class="hljs-string">"<span class="hljs-variable">$releases_list</span>"</span>
  <span class="hljs-keyword">else</span>

    <span class="hljs-built_in">local</span> to_keep=<span class="hljs-variable">$keep</span>
    [[ <span class="hljs-string">"<span class="hljs-variable">$command</span>"</span> == <span class="hljs-string">"deploy"</span> ]] &amp;&amp; to_keep=$((to_keep-1))

    <span class="hljs-built_in">local</span> to_delete=<span class="hljs-variable">$keep</span>
    [[ <span class="hljs-string">"<span class="hljs-variable">$command</span>"</span> != <span class="hljs-string">"deploy"</span> ]] &amp;&amp; to_delete=$((to_delete+1))

    releases_to_keep=<span class="hljs-string">"<span class="hljs-variable">$(echo "$releases_list"|tail -n "$to_keep")</span>"</span>
    releases_to_delete=<span class="hljs-string">"<span class="hljs-variable">$(echo "$releases_list"|reverse|tail -n "+$to_delete"|reverse)</span>"</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">echo</span>

  <span class="hljs-keyword">for</span> old_release <span class="hljs-keyword">in</span> <span class="hljs-variable">$releases_to_delete</span>; <span class="hljs-keyword">do</span>
    log_color <span class="hljs-variable">$COLOR_RED</span> <span class="hljs-string">"<span class="hljs-variable">$path</span>/releases/<span class="hljs-variable">$old_release</span> (will be deleted)"</span>
  <span class="hljs-keyword">done</span></pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Old releases that will be kept will be shown in green.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> old_release <span class="hljs-keyword">in</span> <span class="hljs-variable">$releases_to_keep</span>; <span class="hljs-keyword">do</span>
    log_color <span class="hljs-variable">$COLOR_GREEN</span> <span class="hljs-string">"<span class="hljs-variable">$path</span>/releases/<span class="hljs-variable">$old_release</span> (will be kept)"</span>
  <span class="hljs-keyword">done</span>

  <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$command</span>"</span> == <span class="hljs-string">"deploy"</span> ]]; <span class="hljs-keyword">then</span></pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>During deployment, the current release being deployed is also indicated in green
(as it counts towards the <code>keep</code> number).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    log_color <span class="hljs-variable">$COLOR_GREEN</span> <span class="hljs-string">"<span class="hljs-variable">$path</span>/releases/<span class="hljs-variable">$release</span> (current)"</span>
  <span class="hljs-keyword">fi</span></pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>If there are any releases to delete, <strong>deploy</strong> will ask for confirmation
(unless the <code>-y, --yes</code> command line option or the <code>$DEPLOY_YES</code> variable is specified).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$releases_to_delete</span>"</span> &amp;&amp; <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_YES</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span>

    <span class="hljs-built_in">local</span> number_of_releases_to_delete=<span class="hljs-string">"<span class="hljs-variable">$(echo "$releases_to_delete"|wc -l)</span>"</span>
    <span class="hljs-built_in">local</span> message=<span class="hljs-string">"<span class="hljs-variable">$number_of_releases_to_delete</span> release"</span>
    <span class="hljs-built_in">test</span> <span class="hljs-string">"<span class="hljs-variable">$number_of_releases_to_delete</span>"</span> -ne 1 &amp;&amp; message=<span class="hljs-string">"<span class="hljs-variable">${message}</span>s"</span>

    <span class="hljs-keyword">while</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$delete_releases</span>"</span>; <span class="hljs-keyword">do</span>

      log_prompt <span class="hljs-string">"<span class="hljs-variable">$message</span> will be deleted; please confirm (yes/no) "</span>
      <span class="hljs-built_in">read</span> delete_releases</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Responding “no” interrupts the deployment and prints a help message explaining
how to configure the <code>keep</code> number.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> prompt_is_no <span class="hljs-string">"<span class="hljs-variable">$delete_releases</span>"</span>; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Use the \"keep\" configuration file option, the -k|--keep command line option"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"or the \$DEPLOY_KEEP variable to change the number of old releases that are kept"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"(use the value \"all\" to keep all releases forever)."</span>
        abort <span class="hljs-string">"<span class="hljs-variable">$command</span> interrupted"</span>
      <span class="hljs-keyword">elif</span> ! prompt_is_yes <span class="hljs-string">"<span class="hljs-variable">$delete_releases</span>"</span>; <span class="hljs-keyword">then</span>
        delete_releases=
      <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span>
  <span class="hljs-keyword">fi</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>The actual cleanup of old releases is always performed <strong>after successful deployment</strong>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">delete_old_releases</span></span>() {

  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$releases_to_delete</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">return</span> 0
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">log</span> deleting old releases

  <span class="hljs-built_in">local</span> path=$(get_last_config_key_value path)

  <span class="hljs-built_in">local</span> old_ifs=<span class="hljs-variable">$IFS</span>
  IFS=$<span class="hljs-string">'\n'</span>

  <span class="hljs-built_in">local</span> directories=
  <span class="hljs-keyword">for</span> release <span class="hljs-keyword">in</span> <span class="hljs-variable">$releases_to_delete</span>; <span class="hljs-keyword">do</span>
    IFS=<span class="hljs-string">"<span class="hljs-variable">$old_ifs</span>"</span>
    directories=<span class="hljs-string">"<span class="hljs-variable">$directories</span> \"<span class="hljs-variable">$path</span>/releases/<span class="hljs-variable">$release</span>\""</span>
    IFS=$<span class="hljs-string">'\n'</span>
  <span class="hljs-keyword">done</span>

  IFS=<span class="hljs-string">"<span class="hljs-variable">$old_ifs</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>A single <code>rm</code> command is executed on the host through SSH,
deleting all appropriate old release directories in one go.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run <span class="hljs-string">"rm -fr <span class="hljs-variable">$directories</span>"</span>

  <span class="hljs-built_in">local</span> number_of_releases_to_delete=<span class="hljs-string">"<span class="hljs-variable">$(echo "$releases_to_delete"|wc -l)</span>"</span>
  <span class="hljs-built_in">local</span> message=<span class="hljs-string">"<span class="hljs-variable">$number_of_releases_to_delete</span> old release"</span>
  <span class="hljs-built_in">test</span> <span class="hljs-string">"<span class="hljs-variable">$number_of_releases_to_delete</span>"</span> -ne 1 &amp;&amp; message=<span class="hljs-string">"<span class="hljs-variable">${message}</span>s"</span>

  <span class="hljs-built_in">echo</span>
  log_success <span class="hljs-string">"<span class="hljs-variable">$message</span> deleted"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <!-- annotated-source-only -->
<h2 id="output-exit-codes">Output &amp; exit codes</h2>
<p><strong>deploy</strong> will log various messages indicating what it is doing.</p>

            </div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>Those messages are printed in colors by default on interactive terminals (this can be disabled with the <code>--color never</code> option or <code>$DEPLOY_COLOR</code> variable).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">echo_color</span></span>() {
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$COLORS</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_COLOR</span>"</span> == <span class="hljs-string">"always"</span> ]; <span class="hljs-keyword">then</span>
      COLORS=yes
    <span class="hljs-keyword">elif</span> [ <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_COLOR</span>"</span> != <span class="hljs-string">"never"</span> ] &amp;&amp; is_interactive; <span class="hljs-keyword">then</span>
      COLORS=yes
    <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">local</span> color=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">shift</span>
  <span class="hljs-built_in">local</span> message=<span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>

  <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$COLORS</span>"</span> == <span class="hljs-string">"yes"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\033[<span class="hljs-variable">${color}</span>m<span class="hljs-variable">${message}</span>\033[0m"</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$message</span>"</span>
  <span class="hljs-keyword">fi</span>
}

<span class="hljs-function"><span class="hljs-title">is_interactive</span></span>() {
  <span class="hljs-built_in">test</span> <span class="hljs-string">"<span class="hljs-variable">${-#*i}</span>"</span> != <span class="hljs-string">"$-"</span> || <span class="hljs-built_in">test</span> -t 0 || <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$PS1</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <ul>
<li><strong>Deployment progress updates</strong> will be printed in bold.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">log</span></span>() {
  <span class="hljs-built_in">echo</span>
  echo_color <span class="hljs-variable">$COLOR_BOLD</span> <span class="hljs-string">"  ○ <span class="hljs-variable">$@</span>"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <ul>
<li><strong>Commands executed</strong> on the host will be printed in yellow.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">log_command</span></span>() {
  echo_color <span class="hljs-variable">$COLOR_YELLOW</span> <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span> | tr -s <span class="hljs-string">' '</span> | sed <span class="hljs-string">'s/^/    /'</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <ul>
<li><strong>Input prompts</strong> will be printed in magenta.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">log_prompt</span></span>() {
  <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"<span class="hljs-variable">$(echo_color $COLOR_MAGENTA "$@")</span>"</span> | tr -s <span class="hljs-string">' '</span> | sed <span class="hljs-string">'s/^/    /'</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <ul>
<li>Some output will be printed in various colors to indicate status.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">log_color</span></span>() {
  <span class="hljs-built_in">local</span> color=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">shift</span>
  <span class="hljs-built_in">local</span> message=<span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
  echo_color <span class="hljs-string">"<span class="hljs-variable">$color</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$message</span>"</span> | tr -s <span class="hljs-string">' '</span> | sed <span class="hljs-string">'s/^/    /'</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <ul>
<li><strong>Success</strong> message will be printed in green.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">log_success</span></span>() {
  echo_color <span class="hljs-variable">$COLOR_GREEN</span> <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span> | tr -s <span class="hljs-string">' '</span> | sed <span class="hljs-string">'s/^/    /'</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <ul>
<li><strong>Errors</strong> will be printed in red.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">log_error</span></span>() {
  echo_color <span class="hljs-variable">$COLOR_RED</span> <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span> 1&gt;&amp;2
}</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>If <strong>deploy</strong> encounters an unrecoverable error, it will log an error and exit with status 1.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">abort</span></span>() {
  <span class="hljs-built_in">local</span> message=<span class="hljs-string">"<span class="hljs-variable">$(echo "$@"|sed 's/^ *//'|sed 's/^/  /')</span>"</span>
  <span class="hljs-built_in">echo</span>
  log_error <span class="hljs-string">"<span class="hljs-variable">$message</span>"</span>
  <span class="hljs-built_in">echo</span>
  <span class="hljs-built_in">exit</span> 1
}

<span class="hljs-function"><span class="hljs-title">prompt_is_yes</span></span>() {
  [[ <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> =~ ^(1|y|yes|t|<span class="hljs-literal">true</span>)$ ]]
}

<span class="hljs-function"><span class="hljs-title">prompt_is_no</span></span>() {
  [[ <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> =~ ^(0|n|no|f|<span class="hljs-literal">false</span>)$ ]]
}

<span class="hljs-function"><span class="hljs-title">reverse</span></span>() {
  tac 2&gt; /dev/null || tail -r
}

<span class="hljs-function"><span class="hljs-title">script_arg</span></span>() {
  <span class="hljs-built_in">local</span> i=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$i</span>"</span> &amp;&amp; i=0
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${DEPLOY_ARGS[$i]}</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">script_arg_count</span></span>() {
  <span class="hljs-built_in">echo</span> <span class="hljs-variable">${#DEPLOY_ARGS[@]}</span>
}

<span class="hljs-function"><span class="hljs-title">script_has_args</span></span>() {
  <span class="hljs-built_in">test</span> <span class="hljs-variable">${#DEPLOY_ARGS[@]}</span> -gt 0
}

<span class="hljs-function"><span class="hljs-title">script_has_option</span></span>() {
  <span class="hljs-built_in">local</span> option=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-keyword">for</span> actual_option <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${DEPLOY_OPTIONS[@]}</span>"</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$option</span>"</span> == <span class="hljs-string">"<span class="hljs-variable">$actual_option</span>"</span> ]]; <span class="hljs-keyword">then</span>
      <span class="hljs-built_in">return</span> 0
    <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">done</span>
  <span class="hljs-built_in">return</span> 1
}

<span class="hljs-function"><span class="hljs-title">script_shift</span></span>() {
  <span class="hljs-built_in">local</span> by=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$by</span>"</span> &amp;&amp; by=1
  DEPLOY_ARGS=(<span class="hljs-string">"<span class="hljs-variable">${DEPLOY_ARGS[@]:$by}</span>"</span>)
}

<span class="hljs-function"><span class="hljs-title">script_remove_args</span></span>() {

  <span class="hljs-built_in">local</span> slice_index=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">local</span> slice_length=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
  <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$slice_length</span>"</span> &amp;&amp; slice_length=1

  <span class="hljs-built_in">local</span> arg_count=<span class="hljs-string">"<span class="hljs-variable">${#DEPLOY_ARGS[@]}</span>"</span>
  <span class="hljs-built_in">local</span> rest_index=$((slice_index+slice_length))
  <span class="hljs-built_in">local</span> rest_length=$((arg_count-rest_index))

  DEPLOY_ARGS=(<span class="hljs-string">"<span class="hljs-variable">${DEPLOY_ARGS[@]:0:$slice_index}</span>"</span> <span class="hljs-string">"<span class="hljs-variable">${DEPLOY_ARGS[@]:$rest_index:$rest_length}</span>"</span>)
}

<span class="hljs-function"><span class="hljs-title">get_long_option</span></span>() {
  <span class="hljs-built_in">local</span> option=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$option</span>"</span> =~ ^-[A-Za-z]$ ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">local</span> letter=<span class="hljs-string">"<span class="hljs-variable">$(echo "$option"|sed 's/^-//')</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$DEPLOY_SHORT_OPTIONS_MAP</span>"</span>|grep <span class="hljs-string">"^<span class="hljs-variable">${letter}</span>:"</span>|sed <span class="hljs-string">'s/^.*://'</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$option</span>"</span>|sed <span class="hljs-string">'s/^-*//'</span>
  <span class="hljs-keyword">fi</span>
}

<span class="hljs-function"><span class="hljs-title">describe_option</span></span>() {
  <span class="hljs-built_in">local</span> option=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">local</span> short_option=<span class="hljs-string">"<span class="hljs-variable">$(echo "$DEPLOY_SHORT_OPTIONS_MAP"|grep ":${option}$"|sed 's/:.*$//')</span>"</span>
  <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$short_option</span>"</span> &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"--<span class="hljs-variable">$option</span>"</span> || <span class="hljs-built_in">echo</span> <span class="hljs-string">"-<span class="hljs-variable">$short_option</span>, --<span class="hljs-variable">$option</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">whitelist_options</span></span>() {
  <span class="hljs-keyword">for</span> option <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${DEPLOY_OPTIONS[@]}</span>"</span>; <span class="hljs-keyword">do</span>

    <span class="hljs-built_in">local</span> allowed=
    <span class="hljs-keyword">for</span> allowed_option <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>; <span class="hljs-keyword">do</span>
      [[ <span class="hljs-string">"<span class="hljs-variable">$option</span>"</span> == <span class="hljs-string">"<span class="hljs-variable">$allowed_option</span>"</span> ]] &amp;&amp; allowed=1 &amp;&amp; <span class="hljs-built_in">break</span>
    <span class="hljs-keyword">done</span>

    <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$allowed</span>"</span> || abort <span class="hljs-string">"option '<span class="hljs-variable">$(describe_option "$option")</span>' is not applicable to command '<span class="hljs-variable">$DEPLOY_COMMAND</span>'"</span>
  <span class="hljs-keyword">done</span>
}

<span class="hljs-function"><span class="hljs-title">whitelist_default_options</span></span>() {
  whitelist_options <span class="hljs-built_in">chdir</span> color config <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">whitelist_deploy_options</span></span>() {
  whitelist_default_options forward-agent host identity path port tty user <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
}

main <span class="hljs-variable">$@</span></pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <h2 id="about-this-page">About this page</h2>
<p>Documentation generated with <a href="http://ashkenas.com/docco/">Docco</a>.
<!-- annotated-source-only-end --></p>

            </div>
            
        </li>
        
    </ul>
  </div>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script><script>
$(function() {
  // Make all external links open a new tab/window
  $('a').not('[href^="#"]').attr('target', '_blank');

  // Mark docco sections with a title for styling
  $('ul.sections > li').not('#title').filter(function() {
    return $(this).find('.annotation h2').length;
  }).addClass('title title-2').end().filter(function() {
    return $(this).find('.annotation h3').length;
  }).addClass('title title-3');

  // Build a table of contents
  var toc = $('#toc');
  var tocSection = toc.closest('li');

  // Only include level 2 titles by default
  var mainTitles = tocSection.nextAll('li').find('h2');
  mainTitles.each(function(i) {

    var title = $(this);

    var tocLine = $('<li />').html($('<a />').attr('href', '#' + title.attr('id')).html(title.html()));
    toc.append(tocLine);

    var sections = $('ul.sections > li');
    var start = sections.index(title.closest('li')) + 1;
    var end;

    var nextTitle = mainTitles[i + 1];
    if (nextTitle) {
      end = sections.index(nextTitle.closest('li'));
    }

    var subTitles = sections.slice(start, end).filter('.title-3').find('.annotation h3');
    if (subTitles.length) {

      var subToc = $('<ul />');
      subTitles.each(function(i) {

        var subTitle = $(this);

        var titleText = subTitle.text();
        titleText = titleText.replace(/(<[^<>]+>|\[[^\[\]]+\])/g, '').trim();

        subToc.append($('<li />').append($('<a />').attr('href', '#' + subTitle.attr('id')).text(titleText)));
      });

      tocLine.append(subToc);
    }
  });

  // Show the table of contents (it is hidden while not built)
  toc.css('display', 'block');
});
</script></body>
</html>
